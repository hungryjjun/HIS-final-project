package kr.or.ddit.contract.controller;

import java.util.List;

import org.apache.ibatis.annotations.Param;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;

import kr.or.ddit.account.vo.AccountVO;
import kr.or.ddit.contract.service.Contractservice;
import kr.or.ddit.contract.vo.ContractVO;
import kr.or.ddit.security.SecurityUtil;
import kr.or.ddit.signature.service.SignatureService;
import kr.or.ddit.signature.vo.SignatureVO;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Controller
public class ContractController {
	@Autowired
	private Contractservice service;
	
	@Autowired
	private SignatureService Signservice;
	
	// ê·¼ë¡œê³„ì•½ì„œ ì¡°íšŒ
	@GetMapping("/contract/List")
	public String ContractList(Model model) {
		List<ContractVO> contractList = service.ContractList();
		model.addAttribute("contractList", contractList);
		return "tiles:contract/contractList";
		}
	// íŠ¹ì • ì‚¬ì›ì˜ ê·¼ë¡œê³„ì•½ì„œ ì¡°íšŒ
	@GetMapping("/contract/detail")
	public String ContractDetail(@RequestParam("empId")String empId, Model model) {
		ContractVO contract = service.selectContract(empId);
		model.addAttribute("contract", contract);
		return "tiles:contract/contractDetail";
	}
	// ê·¼ë¡œê³„ì•½ì„œ ë“±ë¡ í¼
    @GetMapping("/contract/registerForm")
    public String registerForm(Model model) {
    	List<ContractVO> unContractList =service.unContractList(); // ê·¼ë¡œê³„ì•½ì„œê°€ ì—†ëŠ” ì‚¬ì› ì¡°íšŒ
    	model.addAttribute("unContractList", unContractList);
    	model.addAttribute("contract", new ContractVO());
    	return "tiles:contract/contractRegister";
    }
    // ê·¼ë¡œê³„ì•½ì„œ ë“±ë¡
    @PostMapping("/contract/register")
    public String reister(ContractVO contract) {
    	service.insertContract(contract);
    	return "redirect:/contract/List";
    }
    //ì§ì›ì˜ ì„œëª…ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    @PostMapping("/contract/sign")
    public String signContract(@RequestParam("contractId") int contractId, @Param("empId") String empId) {
    	SignatureVO sign = Signservice.getSignature(empId);
    	
    	if (sign != null) {
    		 
    		service.updateContractSign(contractId, sign.getSignId());
    	}
    	return "redirect:/contract/detail?empId=" + empId;
    }
    //ë‚´ ê·¼ë¡œê³„ì•½ì„œ ì¡°íšŒ
    @GetMapping("/contract/myContract")
    public String myContract(Model model) {
    	AccountVO account = SecurityUtil.getrealUser();
    	System.out.println("ğŸ“Œ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´: " + account);

    	if (account != null) {
    	    String empId = account.getEmpId();
    	    System.out.println("ğŸ“Œ ê°€ì ¸ì˜¨ empId: " + empId);
    	} else {
    	    System.out.println("ğŸš¨ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤!");
    	}
    	String empId = account.getEmpId();
    	
    	log.info("empId123123123123123123123123", empId);
    	
    	ContractVO myContract = service.selectMyContract(empId);
    	if (myContract == null) {
    	    System.out.println("ğŸš¨ ê³„ì•½ì„œ ë°ì´í„° ì—†ìŒ: empId = " + empId);
    	} else {
    	    System.out.println("ğŸ“Œ ì¡°íšŒëœ ê³„ì•½ì„œ ë°ì´í„°: " + myContract);
    	}
    	 
    	log.info("myContractssssssssssss", myContract);
    	model.addAttribute("contarct", myContract);
    	
    	return "tiles:contract/myContract";		
    }
    
}
