/**
 * <pre>
 * << ê°œì •ì´ë ¥(Modification Information) >>
 *
 *   ìˆ˜ì •ì¼      			ìˆ˜ì •ì           ìˆ˜ì •ë‚´ìš©
 *  -----------   	-------------    ---------------------------
 * 2025. 3. 21.     	CHOI            ìµœì´ˆ ìƒì„±
 * 2025. 3. 23.     	CHOI            ì‹œí€€ìŠ¤ ê¸°ë°˜ ë™ì  id ì²˜ë¦¬ ì¶”ê°€
 * </pre>
 */

/**  1. ëª¨ë‹¬ì—ì„œ ê²°ì¬ ì–‘ì‹ HTML ë¡œë“œ (AJAX ìºì‹œ ë°©ì§€) */
async function openApprovalForm(templateId, templateTitle) {
    if (!templateId) {
        alert("í…œí”Œë¦¿ IDê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
    }

    // ëª¨ë‹¬ íƒ€ì´í‹€ ì„¤ì •
    document.getElementById('approvalFormModalLabel').textContent = templateTitle + ' ê²°ì¬ ì–‘ì‹';

    // ë¡œë”© UI í‘œì‹œ
    document.getElementById('approvalFormContainer').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2">ê²°ì¬ ì–‘ì‹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
    `;

    // ëª¨ë‹¬ í‘œì‹œ
    var modal = new bootstrap.Modal(document.getElementById('approvalFormModal'));
    modal.show();

    try {
        // ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ timestamp ì¶”ê°€
        let timestamp = new Date().getTime();
        let response = await fetch(`/approval/templates/${templateId}?t=${timestamp}`);
        let htmlContent = await response.text();

        // ê¸°ì¡´ ìš”ì†Œ ì œê±° í›„ ìƒˆë¡œìš´ HTML ì‚½ì…
        document.getElementById('approvalFormContainer').outerHTML = `<div id="approvalFormContainer">${htmlContent}</div>`;
		
		// (ì¤‘ìš”) ë™ì  í…Œì´ë¸” ì´ˆê¸°í™”
		initDynamicTable();
		
		// â€» openApprovalFormì—ì„œëŠ” annualTypesë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ì§€ ì•ŠìŒ.
		
        // ê²°ì¬ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ìë™ ì±„ìš°ê¸°)
        await loadDraftData(templateId);

    } catch (error) {
        console.error("í…œí”Œë¦¿ ë¡œë“œ ì‹¤íŒ¨:", error);
        alert("ê²°ì¬ ì–‘ì‹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
}

/** 2. ëª¨ë‹¬ì´ ë‹«í ë•Œ ê¸°ì¡´ HTML ì‚­ì œ (ìµœì‹  ë°˜ì˜) */
document.getElementById('approvalFormModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('approvalFormContainer').innerHTML = "";
});

/**  3. ê¸°ì•ˆ ë¬¸ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° */
async function loadDraftData(draftId) {
    try {
        const response = await axios.get(`/approval/draft/${draftId}`);
        const draft = response.data;

        console.log("ë¶ˆëŸ¬ì˜¨ ë¬¸ì„œ ë°ì´í„°:", draft);

        // ë°ì´í„° í•„ë“œ ì±„ìš°ê¸°
        document.querySelector("#draftId").value = draft.draftId || ""; // ê¸°ì•ˆì ID ìë™ ì±„ìš°ê¸°
        document.querySelector("#templateId").value = draft.templateId || "";
        document.querySelector("#empId").value = draft.empId || "";
        document.querySelector("#draftTitle").value = draft.draftTitle || "";
        document.querySelector("#draftContent").value = draft.draftContent || "";
        document.querySelector("#draftUrgent").checked = draft.draftUrgent === "Y";
        document.querySelector("#departmentId").value = draft.departmentId || "";

        // `ê¸°ì•ˆì`ì™€ `ë¬¸ì„œë²ˆí˜¸` ìë™ ì±„ìš°ê¸°
        document.querySelector("input[name='draftId']").value = draft.draftId || "";
        document.querySelector("input[name='docNo']").value = draft.docNo || "";
		
		// ì—°ì°¨ íƒ€ì… ì˜µì…˜ ì±„ìš°ê¸° (ì„œë²„ ì‘ë‹µ draftì— annualTypesê°€ í¬í•¨ë˜ì–´ ìˆë‹¤ê³  ê°€ì •)
		if (draft.annualTypes && Array.isArray(draft.annualTypes)) {
           populateAnnualSelect(draft.annualTypes);
		}
		
		
		
        // âœ… ê²°ì¬ì ëª©ë¡ ë™ì  ì¶”ê°€
        fillApproverTable(draft.draftapproverList);
		// ë²„íŠ¼ ë™ì  ì¶”ê°€ 
        showApproverButtons();
	
		
       
    } catch (error) {
        console.error("ğŸš¨ ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
        alert("ë¬¸ì„œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
}

/**
 * ê¸°ì•ˆì ê¸°ì¤€ìœ¼ë¡œ ìŠ¹ì¸ì í…Œì´ë¸”ì„ ë™ì ìœ¼ë¡œ êµ¬ì„±
 * ìŠ¹ì¸ìëª… / ìŠ¹ì¸ ìˆœë²ˆ / ìƒíƒœ / ì‚­ì œ (4ê°œ ì—´)
 */
function fillApproverTable(approvers) {
  // 1) í…Œì´ë¸” ì°¸ì¡°
  var table = document.getElementById("approverTable");
  if (!table) return;

  // 2) ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
  table.innerHTML = "";

  // 3) thead ìƒì„±
  var thead = document.createElement("thead");
  thead.innerHTML = `
    <tr>
      <th style="padding:5px; text-align:center;">ìŠ¹ì¸ìëª…</th>
      <th style="padding:5px; text-align:center;">ìŠ¹ì¸ ìˆœë²ˆ</th>
      <th style="padding:5px; text-align:center;">ìƒíƒœ</th>
      <th style="padding:5px; text-align:center;">ì‚­ì œ</th>
    </tr>
  `;
  table.appendChild(thead);

  // 4) tbody ìƒì„±
  var tbody = document.createElement("tbody");
  tbody.id = "approverTableBody";
  table.appendChild(tbody);

  // 5) approvers ë°ì´í„°ë¡œ í–‰ ì¶”ê°€
  if (approvers && approvers.length > 0) {
    approvers.forEach(function(approver, index) {
      var row = document.createElement("tr");
      row.classList.add("approverRow");

      // ìŠ¹ì¸ìëª… ì…€
      var cellName = document.createElement("td");
      var approverIdVal = approver.approverId || "";
      var approverNameVal = approver.approverName || "";
      cellName.innerHTML = `
        <input type='hidden' class='approverId' value='${approverIdVal}'/>
        <input type='text' class='form-control approverName' value='${approverNameVal}' readonly>
      `;
      row.appendChild(cellName);

      // ìŠ¹ì¸ ìˆœë²ˆ ì…€
      var cellSeq = document.createElement("td");
      cellSeq.innerHTML = `
        <input type='number' class='form-control aprSeq' value='${approver.aprSeq || ""}' readonly>
      `;
      row.appendChild(cellSeq);

      // ìƒíƒœ ì…€
      var cellStatus = document.createElement("td");
      cellStatus.innerHTML = `
        <input type='text' class='form-control aprStatus' value='${approver.aprStatus || "ëŒ€ê¸°"}' readonly>
      `;
      row.appendChild(cellStatus);

      // ì‚­ì œ ë²„íŠ¼ ì…€
      var cellDelete = document.createElement("td");
      cellDelete.innerHTML = `
        <button type='button' class='btn btn-danger remove-row'>ì‚­ì œ</button>
      `;
      row.appendChild(cellDelete);

      tbody.appendChild(row);
    });
  }

  // **(ê¸°ì¡´) ë²„íŠ¼ ìƒì„± ë¡œì§ì€ ì—¬ê¸°ì„œ ì œê±°í•©ë‹ˆë‹¤**  
}

function showApproverButtons() {
    // í…œí”Œë¦¿ì— ì •ì˜ëœ ìŠ¹ì¸ì ëª©ë¡ í…Œì´ë¸” ìš”ì†Œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
    const table = document.getElementById("approverTable");
    if (!table) {
        console.warn("approverTable ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í…œí”Œë¦¿ HTMLì— ìŠ¹ì¸ì ëª©ë¡ í…Œì´ë¸”ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
        return;
    }

    // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ì¤‘ë³µ ìƒì„± ë°©ì§€
    if (!document.getElementById("approverBtnContainer")) {
        const btnContainer = document.createElement("div");
        btnContainer.id = "approverBtnContainer";
        btnContainer.style.marginTop = "10px";
        btnContainer.innerHTML = `
            <button type="button" id="plus1" class="btn btn-primary btn-sm">ìŠ¹ì¸ì ì¶”ê°€</button>
            <button type="button" id="minus1" class="btn btn-danger btn-sm">ìŠ¹ì¸ì ì‚­ì œ</button>
        `;
        // í…Œì´ë¸” ë°”ë¡œ ì•„ë˜ì— ë²„íŠ¼ ì»¨í…Œì´ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
        table.insertAdjacentElement("afterend", btnContainer);
    }
}





/** <select id="annualCode">ì— ì—°ì°¨íƒ€ì… ì˜µì…˜ ë„£ê¸° */
function populateAnnualSelect(annualTypes) {
    console.log("populateAnnualSelect í˜¸ì¶œë¨, ë°ì´í„°:", annualTypes);
    
    const selectElem = document.querySelector("#annualCode");
    if (!selectElem) {
        console.error("IDê°€ 'annualCode'ì¸ select ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™”
    selectElem.innerHTML = `<option value="">ì„ íƒí•˜ì„¸ìš”</option>`;

    annualTypes.forEach(type => {
        // ë°ì´í„° í˜•ì‹ í™•ì¸
        if (!type.annualCode || !type.annualName) {
            console.error("ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë°ì´í„° í˜•ì‹:", type);
            return;
        }
        let option = document.createElement("option");
        option.value = type.annualCode;
        option.textContent = type.annualName;
        selectElem.appendChild(option);
    });
}

/** âœ… 5. ê²°ì¬ ìƒì‹  */
async function submitApprovalForm() {
    const formElement = document.querySelector("#approvalFormContainer form");
    if (!formElement) {
        alert("ì œì¶œí•  ì–‘ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    // ê¸°ì•ˆ ë‚´ìš©: CKEditor ì²˜ë¦¬
    let draftContentValue = document.querySelector("#draftContent").value;
    if(draftContentValue.trim() === ""){
        draftContentValue = "ê¸°ì•ˆìƒì‹ í•©ë‹ˆë‹¤.";
    }

    let draftData = {
        draftId: document.querySelector("#draftId")?.value || null,
        templateId: document.querySelector("#templateId")?.value || "",
        empId: document.querySelector("#empId")?.value || "",
        draftTitle: document.querySelector("input[name='draftTitle']").value,
        draftContent: draftContentValue,
        draftUrgent: document.querySelector("#draftUrgent")?.checked ? "Y" : "N",
        departmentId: document.querySelector("#departmentId")?.value || "",
        draftapproverList: []  // ê²°ì¬ì ëª©ë¡ ë°°ì—´
    };

    // ê²°ì¬ì ëª©ë¡ ë™ì  ì¶”ê°€: approverNameë§Œ ìˆ˜ì§‘ (ê¸°íƒ€ í•„ë“œëŠ” ë°±ì—”ë“œì—ì„œ ê¸°ë³¸ê°’ ì²˜ë¦¬)
    document.querySelectorAll(".approverRow").forEach((row) => {
        let approver = {
            // aprIdëŠ” DBì—ì„œ ì‹œí€€ìŠ¤ë¡œ ì²˜ë¦¬í•  ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ë¹ˆ ë¬¸ìì—´ë¡œ ë³´ë‚´ê±°ë‚˜, í”„ë¡ íŠ¸ì—ì„œ ë”°ë¡œ ê´€ë¦¬
            aprId: "",
            // approverIdëŠ” ë¹ˆ ê°’ìœ¼ë¡œ ë‘ê³ , ë°±ì—”ë“œì—ì„œ ì´ë¦„ìœ¼ë¡œ ì¡°íšŒ í›„ ë§¤í•‘
            approverId: "",
            aprSeq: row.querySelector(".aprSeq")?.value || "",
            aprStatus: row.querySelector(".aprStatus")?.value || "ëŒ€ê¸°",
            aprReason: row.querySelector(".aprReason")?.value || "ê¸°ë³¸ ì‚¬ìœ ",
            approverName: row.querySelector(".approverName")?.value || ""
        };
        draftData.draftapproverList.push(approver);
    });

    // ì—°ì°¨ ì‹ ì²­ì„œ í•„ë“œ
    const leaveDateValue = document.querySelector("#leaveDate")?.value;
    const leaveEndDateValue = document.querySelector("#leaveEndDate")?.value;
    const reasonValue = CKEDITOR.instances.reason ? CKEDITOR.instances.reason.getData() : "";
    const annualCodeValue = document.querySelector("#annualCode")?.value;

    if (leaveDateValue || leaveEndDateValue || annualCodeValue) {
       draftData.annualHistory = {
           leaveDate: leaveDateValue,
           leaveEndDate: leaveEndDateValue,
           reason: reasonValue,
           annualCode: annualCodeValue
       };
    }

    console.log("ì „ì†¡í•  ë°ì´í„°:", JSON.stringify(draftData, null, 2));

    axios.post("/approval/draft/submit", draftData)
        .then(resp => {
            alert("ê²°ì¬ ìƒì‹  ì™„ë£Œ!");
            location.reload();
        })
        .catch(error => {
            console.error("ê²°ì¬ ìƒì‹  ì‹¤íŒ¨:", error.response ? error.response.data : error);
            alert("ê²°ì¬ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        });
}


/* 6. `ìƒì‹ ` ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ */
document.addEventListener("DOMContentLoaded", function () {
    document.querySelector("#submitApprovalBtn").addEventListener("click", submitApprovalForm);
	
	// CKEditorê°€ ì ìš©ëœ draftContent ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆë‹¤ë©´ ì‚­ì œí•˜ê³ , í•´ë‹¹ ìš”ì†Œë¥¼ ìˆ¨ê¹€ ì²˜ë¦¬
    if (CKEDITOR.instances.draftContent) {
        CKEDITOR.instances.draftContent.destroy(true);
    }
    document.getElementById("draftContent").style.display = "none";
	
	
});

// ì¶”ê°€ì ìœ¼ë¡œ ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œë§ˆë‹¤ ë‹¤ì‹œ ìˆ¨ê²¨ì£¼ê¸°
$('#approvalFormModal').on('shown.bs.modal', function () {
    document.getElementById("draftContent").style.display = "none";
});


// ìŠ¹ì¸ì ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
$(document).on('click', '#plus1', function() {
    const $tableBody = $('#approverTableBody');
    if (!$tableBody.length) return;

    // ìƒˆ ìˆœë²ˆ ê³„ì‚°
    let maxSeq = 0;
    $tableBody.find('tr').each(function() {
        const seqVal = parseInt($(this).find('.aprSeq').val(), 10) || 0;
        if (seqVal > maxSeq) {
            maxSeq = seqVal;
        }
    });
    const nextSeq = maxSeq + 1;

    // ìƒˆ í–‰ ì¶”ê°€
    const newRow = `
    <tr class="approverRow">
      <td>
        <input type="hidden" class="approverId" value="" />
        <input type="text" class="form-control approverName" placeholder="ìŠ¹ì¸ìëª…" />
      </td>
      <td>
        <input type="number" class="form-control aprSeq" value="${nextSeq}" readonly />
      </td>
      <td>
        <select class="form-control aprStatus" disabled>
          <option value="ëŒ€ê¸°" selected>ëŒ€ê¸°</option>
        </select>
        <input type="hidden" class="aprStatusHidden" value="ëŒ€ê¸°" />
      </td>
    </tr>
    `;
    $tableBody.append(newRow);
});

// ìŠ¹ì¸ì ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
$(document).on('click', '#minus1', function() {
    const $tableBody = $('#approverTableBody');
    if ($tableBody.find('tr').length > 0) {
        $tableBody.find('tr').last().remove();
    }
});

// í–‰ ë‚´ë¶€ì˜ 'ì‚­ì œ' ë²„íŠ¼ ì´ë²¤íŠ¸
$(document).on('click', '.remove-row', function() {
    $(this).closest('tr').remove();
});


