<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 
 * == Í∞úÏ†ïÏù¥Î†•(Modification Information) ==
 *   Í≤∞Ïû¨ ÏßÑÌñâ Mapper
 *   ÏàòÏ†ïÏùº      			ÏàòÏ†ïÏûê           ÏàòÏ†ïÎÇ¥Ïö©
 *  ============   	============== =======================
 *  2025. 3. 18		  CHOI			  Í∏∞ÏïàÏûê Í∏∞Ï§Ä Ï≤òÎ¶¨
 *
-->
<mapper namespace="kr.or.ddit.mybatis.mappers.approval.ApprovalProcessMapper">
	<resultMap id="draftManageMentMap" type="kr.or.ddit.approval.vo.DraftManageMentVO" >
		<id property="draftId" column="DRAFT_ID"/>
		<result property="templateId" column="TEMPLATE_ID"/>
		<result property="empId" column="EMP_ID"/>
		<result property="draftTitle" column="DRAFT_TITLE"/>
		<result property="draftContent" column="DRAFT_CONTENT"/>
		<result property="draftFile" column="DRAFT_FILE"/>
		<result property="draftDate" column="DRAFT_DATE" jdbcType="DATE"/>
		<result property="draftUrgent" column="DRAFT_URGENT"/>
		<result property="departmentId" column="DEPARTMENT_ID"/>
		<result property="draftStatus" column="DRAFT_STATUS"/>
		<!-- ÏµúÏ¢Ö Í≤∞Ïû¨Ïûê Ï†ïÎ≥¥ Ï∂îÍ∞Ä -->
	    <result property="finalApprover" column="FINAL_APPROVER"/>
	    
	    <!-- Ï≤®Î∂ÄÌååÏùº Ïó¨Î∂Ä -->
	    <result property="hasAttachment" column="HAS_ATTACHMENT"/>
		
		
		<!-- Í∏∞ÏïàÏûê Ï†ïÎ≥¥ -->
	    <association property="employee" javaType="kr.or.ddit.employee.vo.EmployeeVO">
	        <id property="empId" column="EMP_ID"/>
	        <result property="name" column="DRAFT_EMP_NAME"/>
	        <result property="departmentId" column="DRAFT_DEPARTMENT"/>
	    </association>

	    <!-- Î¨∏ÏÑúÌï® Î™©Î°ù (1:N) -->
	    <collection property="draftBoxList" ofType="kr.or.ddit.approval.vo.DraftBoxVO" autoMapping="true">
	        <id property="boxId" column="BOX_ID"/>
	    </collection>
	
	    <!-- Í≤∞Ïû¨Ïûê Î™©Î°ù (1:N) -->
	    <collection property="draftapproverList" ofType="kr.or.ddit.approval.vo.DraftApproverVO" autoMapping="true" >
	        <id property="aprId" column="APR_ID"/>
	    </collection>
	
	    <!-- Ï∞∏Ï°∞Ïûê/ÏàòÏã†Ïûê Î™©Î°ù (1:N) -->
	    <collection property="draftParList" ofType="kr.or.ddit.approval.vo.DraftParVO">
	        <id property="parId" column="PAR_ID"/>
	    </collection>
	    
	    
        <!--  ÌååÏùº ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï∂îÍ∞Ä -->
	   <collection property="fileDetails" ofType="FileDetailVO">
	       <id property="detailId" column="DETAIL_ID"/>
	       <result property="fileId" column="FILE_ID"/>
	       <result property="fileName" column="FILE_NAME"/>
	       <result property="fileSavename" column="FILE_SAVENAME"/>
	       <result property="filePath" column="FILE_PATH"/>
	       <result property="fileStatus" column="FILE_STATUS"/>
	       <result property="fileSize" column="FILE_SIZE"/>
	       <result property="fileType" column="FILE_TYPE"/>
	       <result property="uploadDate" column="UPLOAD_DATE"/>
	   </collection>
	    
	    
	    
	    
</resultMap>

<!-- Í∏∞Ïïà ÏÉÅÏÑ∏ Ï†ïÎ≥¥ VO Îß§Ìïë -->
<resultMap id="draftDetailMap" type="kr.or.ddit.approval.vo.DraftDetailVO">
    <!-- Í∏∞Ïïà Î¨∏ÏÑú Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
    <id property="draftId" column="DRAFT_ID"/>
    <result property="draftTitle" column="DRAFT_TITLE"/>
    <result property="draftContent" column="DRAFT_CONTENT"/>
    <result property="draftDate" column="DRAFT_DATE" jdbcType="DATE"/>
    <result property="draftStatus" column="DRAFT_STATUS"/>
    <result property="empId" column="EMP_ID"/>
    <result property="empName" column="EMPNAME"/>
    <result property="department" column="DEPARTMENT"/>
    
    <!-- Ïó∞Ï∞® Ïù¥Î†• Í¥ÄÎ†® Ï†ïÎ≥¥ -->
    <result property="leaveDate" column="LEAVE_DATE" jdbcType="DATE"/>
    <result property="leaveEndDate" column="LEAVE_END_DATE" jdbcType="DATE"/>
    <result property="reason" column="REASON"/>
    <result property="annualCode" column="ANNUAL_CODE"/>
    <result property="annualName" column="ANNUALNAME"/>
    
    <!-- Îã®Ïùº Í≤∞Ïû¨Ïûê Ï†ïÎ≥¥ (ÎåÄÌëú Í≤∞Ïû¨Ïûê) - ÌïÑÏöî Ïãú -->
    <result property="approverId" column="APPROVER_ID"/>
    <result property="aprSeq" column="APR_SEQ"/>
    <result property="aprStatus" column="APR_STATUS"/>
    <result property="aprReason" column="APR_REASON"/>
    
    <!-- Îã§Ï§ë Í≤∞Ïû¨Ïûê Î™©Î°ù -->
    <collection property="draftApproverList" ofType="kr.or.ddit.approval.vo.DraftApproverVO">
        <id property="aprId" column="APR_ID"/>
        <result property="approverId" column="APPROVER_ID"/>
        <result property="aprSeq" column="APR_SEQ"/>
        <result property="aprStatus" column="APR_STATUS"/>
        <result property="aprReason" column="APR_REASON"/>
        <result property="empSid" column="EMP_SID"/>
    </collection>
</resultMap>
	


	<!-- Í∏∞ÏïàÏûêÍ∞Ä Î≥∏Ïù∏Ïùò ÏÉÅÏã†Ìï® ÏøºÎ¶¨!! -->
	<select id="writeDraftMangeMent" resultMap="draftManageMentMap" parameterType="String">
	    SELECT
	        dm.draft_id,
	        dm.draft_title,
	        dm.draft_date,
	        dm.draft_status,
	        emp.name          AS draft_emp_name,
	        emp.department_id AS draft_department,
	        (
	            SELECT name
	            FROM employee
	            WHERE emp_id = (
	                SELECT approver_id
	                FROM draft_approver
	                WHERE draft_id = dm.draft_id
	                ORDER BY apr_seq DESC
	                FETCH FIRST 1 ROWS ONLY
	            )
	        ) AS final_approver,
	        CASE
	            WHEN dm.draft_file IS NOT NULL THEN 1
	            ELSE 0
	        END AS has_attachment
	    FROM
	        draft_management dm
	    JOIN employee emp ON dm.emp_id = emp.emp_id
	    WHERE
	        dm.emp_id = #{empId}
	        AND dm.draft_status IN ('ÎåÄÍ∏∞', 'Í≤∞Ïû¨ ÏßÑÌñâ Ï§ë')  -- üõ† ÏÉÅÏã†Ìï® Ï°∞Í±¥ Ï∂îÍ∞Ä
	    ORDER BY
	        dm.draft_date DESC
	</select>

	
	<!-- Í∏∞ÏïàÎêú Î¨∏ÏÑú Ï†ÑÏ≤¥ Î¶¨Ïä§Ìä∏ Ï°∞Ìöå -> Í∏∞ÏïàÏûê Ï†ïÎ≥¥, Î¨∏ÏÑú Ïπ¥ÌÖåÍ≥†Î¶¨, ÏµúÏ¢Ö Í≤∞Ïû¨Ïûê, Ï≤®Î∂Ä ÌååÏùº Ïó¨Î∂Ä  -->
	<select id="writeDraftMangeMentList" resultMap="draftManageMentMap">
		SELECT
		    dm.draft_id
		  , dm.draft_title
		  , dm.draft_date
		  , dm.draft_status
		  , emp.name AS draft_emp_name
		  , dt.template_category
		  , coalesce(to_char(emp.department_id)
		             , 'ÎØ∏ÏßÄÏ†ï') AS draft_department
		  , (
		        SELECT
		            name
		        FROM
		            employee
		        WHERE
		            emp_id = (
		                SELECT
		                    approver_id
		                FROM
		                    draft_approver
		                WHERE
		                    draft_id = dm.draft_id
		                ORDER BY
		                    apr_seq DESC
		                FETCH FIRST 1 ROWS ONLY
		            )
		    )        AS final_approver
		  , CASE
		          WHEN dm.draft_file IS NOT NULL THEN
		              1
		          ELSE
		              0
		      END      AS has_attachment
		FROM
		         draft_management dm
		    JOIN employee       emp ON dm.emp_id = emp.emp_id
		    JOIN draft_template dt ON dm.template_id = dt.template_id
		ORDER BY
		    dm.draft_date DESC
	
	</select>
	
	
	<!-- 1. Ï†ÑÏûêÍ≤∞Ïû¨ Î¨∏ÏÑú Í∏∞Ïïà (INSERT)  -> Î¨∏ÏÑú ÌèºÏù¥ Î∞îÎÄåÏñ¥ÎèÑ Ï≤òÎ¶¨ Í∞ÄÎä•Ìï® -->
   <insert id="insertDraftManagement" parameterType="DraftManageMentVO">
    <!-- draftIdÏôÄ templateIdÎäî ÏãúÌÄÄÏä§ Í∞íÏúºÎ°ú ÏûêÎèô ÏÉùÏÑ± -->
    	   <!-- 1) INSERT Ï†ÑÏóê ÏãúÌÄÄÏä§ Í∞í ÎØ∏Î¶¨ Ï°∞Ìöå -->
	    <selectKey keyProperty="draftId" resultType="Long" order="BEFORE">
	        SELECT DRAFT_ID_SEQ.NEXTVAL FROM DUAL
	    </selectKey>
    
    
	    INSERT INTO DRAFT_MANAGEMENT (
	        DRAFT_ID, TEMPLATE_ID, EMP_ID, DRAFT_TITLE, 
	        DRAFT_CONTENT, DRAFT_DATE, DRAFT_URGENT, 
	        DEPARTMENT_ID, DRAFT_STATUS, DRAFT_FILE
	    ) VALUES (
	        #{draftId}, #{templateId}, #{empId}, #{draftTitle}, 
	        #{draftContent}, SYSDATE, #{draftUrgent}, 
	        #{departmentId}, 'ÎåÄÍ∏∞', #{draftFile}
	    )
	</insert>
	<!-- ÌÖúÌîåÎ¶ø Ï†úÎ™© Ï°∞Ìöå -->
	<select id="selectTemplateTitle" parameterType="Long" resultType="String">
	    SELECT TEMPLATE_TITE
	    FROM DRAFT_TEMPLATE
	    WHERE TEMPLATE_ID = #{templateId}
	</select>
	

    <!-- 2. Í≤∞Ïû¨Ïûê Ï†ïÎ≥¥ Ï∂îÍ∞Ä -->
	<insert id="insertDraftApprover" parameterType="kr.or.ddit.approval.vo.DraftApproverVO">
		<selectKey keyProperty="aprId" resultType="Long" order="BEFORE">
			 SELECT APR_ID_SEQ.NEXTVAL FROM DUAL
		</selectKey>
	    INSERT INTO DRAFT_APPROVER (
	        APR_ID, DRAFT_ID, APPROVER_ID, APR_SEQ, 
	        APR_YN, APR_STATUS, APR_DATE, APR_REASON, APPROVER_NAME
	    ) VALUES (
	       #{aprId}, #{draftId}, #{approverId}, #{aprSeq}, 
	        'N', #{aprStatus}, SYSDATE, #{aprReason}, #{approverName}
	    )
	</insert>
	<!-- Í≤∞Ïû¨Ïûê Ïù¥Î¶Ñ Ï∞æÍ∏∞ -->
	<select id="selectApproverName" parameterType="String" resultType="kr.or.ddit.approval.vo.DraftApproverVO">
		 SELECT 
	       e.NAME as approverName
	    FROM DRAFT_APPROVER a
	    JOIN EMPLOYEE e ON a.APPROVER_ID = e.EMP_ID
	    WHERE e.NAME = #{approverName}
	</select>
	
	
	<!-- Í≤∞Ïû¨Ïûê Ïù¥Î¶ÑÌïòÍ≥† idÎûë Îß§Ìïë  -->
	<select id="selectEmpIdByName" parameterType="String" resultType="String">
		SELECT emp_id
	    FROM account
	    WHERE EMP_NAME = #{approverName}
	</select>
	
	<!-- Ïó∞Ï∞® Ïã†Ï≤≠ÏÑúÏóê Ìï¥Îãπ ÌÉÄÏûÖ Î¶¨Ïä§Ìä∏ Î∂àÎü¨Ïò§Í∏∞  -->
	<select id="selectAvailableAnnualTypes" resultType="kr.or.ddit.annual.vo.AnnualManageVO">
	    SELECT ANNUAL_CODE as cd,
	           ANNUAL_NAME as nm,
	           ANNUAL_INFO,
	           ANNUAL_STATUS
	      FROM ANNUAL_TYPE
	     WHERE ANNUAL_STATUS = 'Y'
	     ORDER BY ANNUAL_CODE
	</select>
	
	<!--Ïó∞Ï∞® Ïã†Ï≤≠ÏÑú  ÏûëÏÑ± -->
	<insert id="insertAnnualHistory" parameterType="kr.or.ddit.annual.vo.AnnualHistoryVO">
	    <!-- ÏãúÌÄÄÏä§Î•º ÏÇ¨Ïö©ÌïòÏó¨ PRIMARY KEY ÏÉùÏÑ± (Ïò§ÎùºÌÅ¥ Í∞ÄÏ†ï) -->
	    <selectKey keyProperty="historyId" resultType="Long" order="BEFORE">
	        SELECT HISTORY_ID_SEQ.NEXTVAL FROM DUAL
	    </selectKey>
	    INSERT INTO ANNUAL_HISTORY (
	        HISTORY_ID, EMP_ID, LEAVE_DATE, LEAVE_END_DATE,
	        STATUS, REASON, REJECT_REASON, REQUEST_DATE, ANNUAL_CODE, DRAFT_ID
	        
	    ) VALUES (
	        #{historyId}, #{empId}, 
	        TO_DATE(#{leaveDate}, 'YYYY-MM-DD'),
        	TO_DATE(#{leaveEndDate}, 'YYYY-MM-DD'),
	        #{status},
	        #{reason}, #{rejectReason}, SYSDATE, #{annualCode}, #{draftId}
	    )
	</insert>
	

    <!-- 3. Î¨∏ÏÑúÌï® Îì±Î°ù -->
	<insert id="insertDraftBox" parameterType="DraftBoxVO">
		<selectKey keyProperty="boxId" resultType="Long" order="BEFORE">
			 SELECT BOX_ID_SEQ.NEXTVAL FROM DUAL
		</selectKey>
	    INSERT INTO DRAFT_BOX (
	        BOX_ID, DRAFT_ID, EMP_ID, APPROVER_ID, 
	        DOC_TITLE, DOC_STATUS, DOC_CATEGORY, DOC_TYPE, 
	        LAST_UPDATE, CREATE_DATE, DOC_FILE
	    ) VALUES (
	        #{boxId}, #{draftId}, #{empId}, #{approverId}, 
	        #{docTitle}, 'ÎåÄÍ∏∞', #{docCategory}, #{docType}, 
	        SYSDATE, SYSDATE, #{docFile}
	    )
	</insert>


    <!-- 4. Í≤∞Ïû¨Ïûê Ï≤òÎ¶¨ (ÏäπÏù∏/Î∞òÎ†§/Î≥¥Î•ò) -->
    <update id="updateDraftApprover" parameterType="kr.or.ddit.approval.vo.DraftApproverVO">
        UPDATE DRAFT_APPROVER
        SET APR_YN = 'Y', 
            APR_STATUS = #{aprStatus}, 
            APR_DATE = SYSDATE, 
            APR_REASON = #{aprReason}
        WHERE DRAFT_ID = #{draftId} AND APPROVER_ID = #{approverId}
    </update>

    <!-- 5. ÎÇ®ÏùÄ Í≤∞Ïû¨Ïûê Ïàò ÌôïÏù∏ (ÎßàÏßÄÎßâ Í≤∞Ïû¨Ïûê Ï≤¥ÌÅ¨) -->
    <select id="countPendingApprovals" parameterType="Long" resultType="int">
        SELECT COUNT(*) 
        FROM DRAFT_APPROVER
        WHERE DRAFT_ID = #{draftId} 
        AND APR_YN = 'N'
    </select>

    <!-- 6. Î¨∏ÏÑú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ (ÎßàÏßÄÎßâ Í≤∞Ïû¨Ïûê ÏäπÏù∏ Ïãú) -->
    <update id="updateDraftManagementStatus" parameterType="DraftManageMentVO">
        UPDATE DRAFT_MANAGEMENT
        SET DRAFT_STATUS = #{draftStatus}
        WHERE DRAFT_ID = #{draftId}
    </update>

    <!--  7. Î¨∏ÏÑúÌï® ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ -->
    <update id="updateDraftBoxStatus" parameterType="DraftBoxVO">
        UPDATE DRAFT_BOX
        SET DOC_STATUS = #{docStatus}, LAST_UPDATE = SYSDATE
        WHERE DRAFT_ID = #{draftId}
    </update>
	
	
	<!-- FILE_DETAIL ÌÖåÏù¥Î∏îÏóê Í∏∞ÏïàÍ¥ÄÎ¶¨ IDÏôÄ ÌååÏùº ID Îß§Ìïë -->
	<insert id="insertDraftMentFile" parameterType="map" >
        INSERT INTO FILE_DETAIL (FILE_ID, DRAFT_FILE)
        SELECT
            F.FILE_ID,
            #{draftId}
        FROM "FILE" F
        WHERE F.FILE_ID = #{fileIds}
	</insert>
	
	<!--  Ìï¥Îãπ Î¨∏ÏÑúÏóê Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞ Í∞íÎì§ -> Í≤∞Ïû¨ ÎåÄÍ∏∞Ìï®Ïù¥ÎÇò ÎØ∏Í≤∞Ìï®ÏóêÏÑú Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Îïå ÏÇ¨Ïö©   -->
	<select id="getDraftDocDetail" resultMap="draftDetailMap" parameterType="Long">
		SELECT
		    dm.draft_id,
		    dm.draft_title,
		    dm.draft_content,
		    dm.draft_date,
		    dm.draft_status,
		    dm.emp_id,
		    e.name AS empName,
		    e.department_id AS department,
		    an.leave_date,
		    an.leave_end_date,
		    an.reason,
		    an.annual_code,             
		    at.annual_name AS annualName,
		    da.approver_id,
		    da.apr_seq,
		    da.apr_status,
		    da.apr_reason
		FROM draft_management dm
		JOIN annual_history an 
		    ON dm.emp_id = an.emp_id
		    AND TO_CHAR(dm.draft_date, 'YYYY-MM-DD') = TO_CHAR(an.leave_date, 'YYYY-MM-DD')
		JOIN annual_type at
		    ON an.annual_code = at.annual_code
		JOIN employee e
		    ON dm.emp_id = e.emp_id
		JOIN draft_approver da
		    ON dm.draft_id = da.draft_id
		WHERE dm.draft_id = #{draftId}
	
	</select>
	
	
</mapper>