<!-- 
 * == ê°œì •ì´ë ¥(Modification Information) ==
 *   
 *   ìˆ˜ì •ì¼      			ìˆ˜ì •ì           ìˆ˜ì •ë‚´ìš©
 *  ============   	============== =======================
 *  2025. 3. 29.     	ì •íƒœìš°            ìµœì´ˆ ìƒì„±
 *
-->
<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link
	href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
	rel="stylesheet">

<style>
body {
	font-family: 'Roboto', sans-serif;
	margin: 0;
	padding: 0;
	background-color: #f4f6f9;
}

.container {
	width: 100%;
	max-width: 1600px;
	margin: auto;
	padding: 30px;
	background: white;
	box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1);
	border-radius: 12px;
}

h2 {
	text-align: center;
	font-weight: 700;
	margin-bottom: 30px;
	color: #333;
}

.summary {
	display: flex;
	justify-content: space-between;
}

.card {
	color: black;
	border-radius: 8px;
	font-size: 18px;
	font-weight: bold;
	width: 30%;
	text-align: center;
	box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
}

.card span {
	display: block;
	font-size: 22px;
}

.accordion {
	display: flex;
	justify-content: space-between;
	gap: 20px;
	margin-bottom: 30px;
}

table {
	width: 100%;
	border-collapse: collapse;
	margin-top: 10px;
}

th, td {
	padding: 12px;
	border-bottom: 1px solid #ddd;
}

td {
	text-align: left;
	white-space: nowrap;
}
/* thëŠ” ì¤‘ì•™ ì •ë ¬ */
th {
	background-color: #f1f1f1;
	text-align: center;
}

tr:hover {
	background-color: #f9f9f9;
}
</style>
<h3>ì—°ì°¨ ë‚´ì—­</h3>
<div class="container">
	<h5>
		${annualDetail[0].employee.department.departmentName}
		${annualDetail[0].employee.team.teamName}
		${annualDetail[0].employee.name}
		${annualDetail[0].employee.rank.rankName}
	</h5>
			<input type="hidden" value="${annualDetail[0].empId}" id="empId" /> 
	<h2>
		<span id="currentMonth">2025</span>
	</h2>

	<div class="summary">
		<div class="card">
			ì´ ì—°ì°¨: <span id="yearTotalAnnual"> 15</span>
		</div>
		<div class="card">
			ì‚¬ìš© ì—°ì°¨: <span id="userAnnual"> 0</span>
		</div>
		<div class="card">
			ì”ì—¬ ì—°ì°¨: <span id="remainAnnual"> 0</span>
		</div>
	</div>
</div>
ì—°ì°¨ ì‚¬ìš© ê¸°ê°„
<div>
	<select>
		<option>2023-01-01 ~ 2023-12-31</option>
		<option>2024-01-01 ~ 2024-12-31</option>
		<option>2025-01-01 ~ 2025-12-31</option>
	</select>
</div>
<div class="container">
	<div class="accordion" id="weeksAccordion">
		<table>
			<thead>
				<tr>
					<th>ìœ í˜•</th>
					<th>ê¸°ê°„</th>
					<th>ì‚¬ìš© ì—°ì°¨</th>
					<th>ì‚¬ìœ </th>
				</tr>
			</thead>
			<tbody>
				<c:forEach items="${annualDetail}" var="x">
					<tr>
						<td>${x.annualType.annualName }</td>
						<td>${x.leaveDate ~ x.leaveEndDate}</td>
						<td></td>
						<td>${x.reason}</td>
					</tr>
				</c:forEach>
			</tbody>
			<!-- ë™ì ìœ¼ë¡œ ë‚ ì§œë³„ë¡œ ì¶”ê°€ë  ë¶€ë¶„ -->
		</table>
	</div>
</div>
<script>
//í˜„ì¬ ì—°ë„ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
function updateYear(yearOffset) {
    let currentYearText = document.getElementById('currentYear').innerText;
    let currentDate = new Date(currentYearText + '-01-01'); // í•´ë‹¹ ì—°ë„ ì‹œì‘ ë‚ ì§œë¡œ ìƒì„±
    currentDate.setFullYear(currentDate.getFullYear() + yearOffset); // ì—°ë„ ë³€ê²½

    let year = currentDate.getFullYear();
    document.getElementById('currentYear').innerText = `${year}`;

    generateTables(year); // í…Œì´ë¸”ì„ ë‹¤ì‹œ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ (ì—°ë„ë¥¼ ì¸ìë¡œ ì „ë‹¬)
    updateSummary(year);   // ìš”ì•½ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì—°ë„ë¥¼ ì¸ìë¡œ ì „ë‹¬)
}


// ì›” ë³€ê²½ ì´ë²¤íŠ¸
function changeMonth(offset) {
	
	let currentMonthText = document.getElementById('currentMonth').innerText;
	let currentDate = new Date(currentMonthText + "-01");  // 2025-03-01 (ì˜ˆì‹œ)

	currentDate.setMonth(currentDate.getMonth() + offset);  // í•œ ë‹¬ ì´ë™

	let year = currentDate.getFullYear();
	let month = (currentDate.getMonth() + 1).toString().padStart(2, '0');  // 0-based indexì´ë¯€ë¡œ +1 í•„ìš”
	document.getElementById('currentMonth').innerText = `\${year}.\${month}`;
	
	let ym = `\${year}-\${month}`;
	
	let empId = document.querySelector("#empId").value;
	console.log(empId);
	console.log(ym)
    $.ajax({
        url: '/myAttendance', 
        type: 'GET',
        dataType:"json",
        data: { workDate:ym ,empId:empId },  //2025-2ì™€ empIdì „ë‹¬
        success: function(data) {
        	console.log(data.myAttendance)
            myAttendance = data.myAttendance;
            generateTables(year, month); // í…Œì´ë¸” ê°±ì‹ 
            updateSummary(year, month); // Summary ê°±ì‹ 
        },
        error: function(xhr, status, error) {
            console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
        }
    });
}


// ë‚ ì§œì— ë”°ë¼ í…Œì´ë¸” ìƒì„±
function generateTables(year, month) {
    let leftContainer = document.getElementById('weekLeft').querySelector('tbody');
    let rightContainer = document.getElementById('weekRight').querySelector('tbody');

    leftContainer.innerHTML = "";
    rightContainer.innerHTML = "";

    // í˜„ì¬ ì›”ì˜ ë°ì´í„°ë§Œ í•„í„°ë§
    let filteredData = myAttendance
    .filter(x => x.workDate.startsWith(`\${year}-\${month}`))
    .sort((a, b) => a.workDate.localeCompare(b.workDate)); // ë‚ ì§œìˆœ ì •ë ¬
    
    filteredData.forEach(x => {
        let day = parseInt(x.workDate.substring(8)); // ë‚ ì§œ ìˆ«ìë¡œ ë³€í™˜
        let tableRow = createTableRow(x);

        if (day <= 15) {
            leftContainer.innerHTML += tableRow; // 1~15ì¼ â†’ ì™¼ìª½
        } else {
            rightContainer.innerHTML += tableRow; // 16ì¼ ì´í›„ â†’ ì˜¤ë¥¸ìª½
        }
    });
}

function updateSummary(year, month) {
    let totalSeconds = 0;
    
    // ì´ë²ˆ ë‹¬ì˜ í‰ì¼(ì›”~ê¸ˆ) ê°œìˆ˜ ê³„ì‚°
    let totalWeekdays = getWeekdaysInMonth(year, month);
    let targetWorkSeconds  = totalWeekdays * 8 * 3600; // í‰ì¼ * 8ì‹œê°„ * ì´ˆ ë‹¨ìœ„ ë³€í™˜

    // ê·¼ë¬´ ë°ì´í„° í•©ì‚°
    myAttendance.forEach(x => {
        if (x.workDate.startsWith(`\${year}-\${month}`)) {
            let totalMinutes = (parseInt(x.workingHours) || 0) * 60 + (parseInt(x.workingMinutes) || 0);
            totalSeconds += totalMinutes * 60; // ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜
        }
    });

    // ì´ˆë¥¼ ì‹œê°„/ë¶„/ì´ˆë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
    function formatTime(seconds) {
        let h = Math.floor(seconds / 3600);
        let m = Math.floor((seconds % 3600) / 60);
        let s = seconds % 60;
        return `\${h}h \${m}m \${s}s`;
    }

    // ì´ë²ˆë‹¬ ì´ˆê³¼ ì‹œê°„ ê³„ì‚° (ëª©í‘œ ê·¼ë¬´ ì‹œê°„ì„ ì´ˆê³¼í•œ ë¶€ë¶„)
    let overtimeSeconds = Math.max(totalSeconds - targetWorkSeconds, 0);

    // ì´ë²ˆë‹¬ ì”ì—¬ ì‹œê°„ ê³„ì‚° (ëª©í‘œ ê·¼ë¬´ ì‹œê°„ì—ì„œ ì•„ì§ ë‚¨ì€ ì‹œê°„)
    let remainSeconds = Math.max(targetWorkSeconds - totalSeconds, 0);

    // DOM ì—…ë°ì´íŠ¸
    document.getElementById("yearTotalAnnual").innerText = formatTime(totalSeconds);
    document.getElementById("userAnnual").innerText = formatTime(overtimeSeconds);
    document.getElementById("remainAnnual").innerText = formatTime(remainSeconds);
}

// ğŸ“Œ ì´ë²ˆ ë‹¬ í‰ì¼ ê°œìˆ˜ ê³„ì‚° í•¨ìˆ˜
function getWeekdaysInMonth(year, month) {
    let count = 0;
    let daysInMonth = new Date(year, month, 0).getDate(); // í•´ë‹¹ ì›”ì˜ ì´ ì¼ìˆ˜

    for (let day = 1; day <= daysInMonth; day++) {
        let date = new Date(year, month - 1, day); // JSì—ì„œ monthëŠ” 0ë¶€í„° ì‹œì‘
        let dayOfWeek = date.getDay(); // 0(ì¼ìš”ì¼) ~ 6(í† ìš”ì¼)

        if (dayOfWeek >= 1 && dayOfWeek <= 5) { // ì›”~ê¸ˆ (1~5)
            count++;
        }
    }
    return count;
}

// ê° ë‚ ì§œì— ëŒ€í•´ í…Œì´ë¸” í–‰ ìƒì„±
var myAttendance = [];

<c:forEach items="${myAttendance}" var="x">
myAttendance.push({
    workDate: "${x.workDate}",
    workStartTime: "${x.workStartTime}",
    workEndTime: "${x.workEndTime}",
    workingHours: "${x.workingHours}",
    workingMinutes: "${x.workingMinutes}",
    overtimeHours: "${x.overtimeHours}",
    overtimeMinutes: "${x.overtimeMinutes}",
    nightWorkHours: "${x.nightWorkHours}",
    nightWorkMinutes: "${x.nightWorkMinutes}"
});
</c:forEach>;

function createTableRow(x) {
	 let workStartTime = x.workStartTime ? x.workStartTime.substring(0, 5) : 'N/A';  // 'N/A'ëŠ” ê¸°ë³¸ê°’
	    let workEndTime = x.workEndTime ? x.workEndTime.substring(0, 5) : 'N/A';  // 'N/A'ëŠ” ê¸°ë³¸ê°’
	    let workDate = x.workDate ? x.workDate.substring(8) : 'N/A';  // 'N/A'ëŠ” ê¸°ë³¸ê°’
    let workingHours = x.workingHours || '0';
    let workingMinutes = x.workingMinutes || '0';
    let overtimeHours = x.overtimeHours || '0';
    let overtimeMinutes = x.overtimeMinutes || '0';
    let nightWorkHours = x.nightWorkHours || '0';
    let nightWorkMinutes = x.nightWorkMinutes || '0';
	
    //ìˆ«ì ë³€í™˜ 
	let NumworkingHours = parseInt(x.workingHours) || 0;
	let NumovertimeHours = parseInt(x.overtimeHours) || 0;
	let NumnightWorkHours = parseInt(x.nightWorkHours) || 0;
	let NumworkingMinutes = parseInt(x.workingMinutes) || 0;
	let NumovertimeMinutes = parseInt(x.overtimeMinutes) || 0;
	let NumnightWorkMinutes = parseInt(x.nightWorkMinutes) || 0;
	
    // ğŸ”¹ ì´ ê·¼ë¬´ì‹œê°„ ê³„ì‚° (ê¸°ë³¸ + ì—°ì¥ + ì•¼ê°„)
    let totalMinutes = (NumworkingHours + NumovertimeHours + NumnightWorkHours) * 60 + (NumworkingMinutes + NumovertimeMinutes + NumnightWorkMinutes);
    let totalHours = Math.floor(totalMinutes / 60);
    let totalResultinutes = totalMinutes % 60;
    
    return `
        <tr>
            <td>\${workDate} </td>
            <td>\${workStartTime}</td>
            <td>\${workEndTime}</td>
            <td>\${totalHours}ì‹œê°„ \${totalResultinutes}ë¶„</td>
            <td>ê¸°ë³¸ \${workingHours}ì‹œê°„ \${workingMinutes}ë¶„ / ì—°ì¥ \${overtimeHours}ì‹œê°„ \${overtimeMinutes}ë¶„ / ì•¼ê°„ \${nightWorkHours}ì‹œê°„ \${nightWorkMinutes}ë¶„</td>
        </tr>
    `;
}

// ì´ˆê¸° í˜ì´ì§€ ë¡œë“œ ì‹œ ì›” ì„¤ì •
document.addEventListener('DOMContentLoaded', function() {
    updateMonth(0);  // í˜„ì¬ ì›”ë¡œ ì´ˆê¸°í™”
});


</script>