function connectWebSocket() {
    console.log("ğŸ”Œ WebSocket ì—°ê²° ì‹œë„...");

    let socket = new SockJS('/wss');  // ì„œë²„ì™€ì˜ ì—°ê²°
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
        console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ: " + frame);

        // ìƒíƒœ ë³€ê²½ ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ
        stompClient.subscribe('/topic/onlineStatus', function (message) {
            let statusUpdate = message.body;
            console.log("ğŸ”„ ìƒíƒœ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ : ", statusUpdate);

            // ì§ì› ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            loadEmployeeList();
        });
    }, function (error) {
        console.error("âŒ WebSocket ì—°ê²° ì‹¤íŒ¨", error);
    });
}

function loadEmployeeList() {
    console.log("ğŸ“¥ ì§ì› ëª©ë¡ ìš”ì²­");

    $.ajax({
        url: "/messenger/empList",
        type: "GET",
        dataType: "json",
        success: function (data) {
            console.log("ğŸ“‹ ì§ì› ëª©ë¡ ìˆ˜ì‹  ì™„ë£Œ", data);

            let empListHtml = `
                <h3>ì§ì› ëª©ë¡</h3>
                <ul id="empList"></ul>
            `;
            $("#contentArea").html(empListHtml);

            data.forEach(emp => {
				console.log("emp.empId =", emp.empId);
                const item = $(`
                    <li class="employee-item"
                        style="margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 10px; cursor: pointer;">
                        <strong>ì´ë¦„:</strong> ${emp.empName}<br>
                        <strong>ë¶€ì„œ:</strong> ${emp.department?.departmentName || 'N/A'}<br>
                        <strong>ì§ê¸‰:</strong> ${emp.empRank || 'N/A'}<br>
                        <strong>íŒ€:</strong> ${emp.teamName || 'N/A'}<br>
                        <strong>ìƒíƒœ:</strong> ${emp.status === 'ì˜¨ë¼ì¸' ? 'ğŸŸ¢ ì˜¨ë¼ì¸' : 'âšª ì˜¤í”„ë¼ì¸'}
                    </li>
                `);

                item.on("click", function () {
                    openChatWith(emp.empId);
                });

                $("#empList").append(item);
            });
        },
        error: function (xhr, status, error) {
            console.error("âŒ ì§ì› ëª©ë¡ ë¡œë”© ì‹¤íŒ¨", status, error);
            alert("ì§ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    });
}

function openChatWith(targetEmpId) {
    const currentEmpId = sessionStorage.getItem("currentUserId"); 
    console.log("âœ… currentUserId: ", currentEmpId);
    console.log("ğŸ¯ targetEmpId: ", targetEmpId); 

    if (!currentEmpId || !targetEmpId) {
        alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    $.ajax({
        url: "/messenger/selectOrInsertRoom",
        method: "POST",
        data: {
            empId1: currentEmpId,
            empId2: targetEmpId
        },
        success: function (roomId) {
            console.log("âœ… ì±„íŒ…ë°© ìƒì„± or ì¡°íšŒ ì„±ê³µ, ROOM_ID: ", roomId);
            window.open("/messenger/room?roomId=" + roomId, "_blank");
        },
        error: function () {
            alert("âŒ ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    });
}
$(document).ready(function () {
    console.log("ğŸ“¦ chatempList.js ë¡œë“œë¨");

    connectWebSocket();
    loadEmployeeList();

    $("#empListBtn").on("click", function (e) {
        e.preventDefault();
        console.log("ğŸ‘† ì§ì› ëª©ë¡ ë²„íŠ¼ í´ë¦­ë¨");
        loadEmployeeList();
    });
});
