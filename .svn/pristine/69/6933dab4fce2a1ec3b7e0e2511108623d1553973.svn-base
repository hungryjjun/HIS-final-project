/**
 * <pre>
 * << ê°œì •ì´ë ¥(Modification Information) >>
 *   
 *   ìˆ˜ì •ì¼      			ìˆ˜ì •ì           ìˆ˜ì •ë‚´ìš©
 *  -----------   	-------------    ---------------------------
 * 2025. 3. 21.     	CHOI            ìµœì´ˆ ìƒì„±
 * 2025. 3. 23.     	CHOI            ì‹œí€€ìŠ¤ ê¸°ë°˜ ë™ì  id ì²˜ë¦¬ ì¶”ê°€
 * </pre>
 */

/**  1. ëª¨ë‹¬ì—ì„œ ê²°ì¬ ì–‘ì‹ HTML ë¡œë“œ (AJAX ìºì‹œ ë°©ì§€) */
async function openApprovalForm(templateId, templateTitle) {
    if (!templateId) {
        alert("í…œí”Œë¦¿ IDê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
    }

    // ëª¨ë‹¬ íƒ€ì´í‹€ ì„¤ì •
    document.getElementById('approvalFormModalLabel').textContent = templateTitle + ' ê²°ì¬ ì–‘ì‹';

    // ë¡œë”© UI í‘œì‹œ
    document.getElementById('approvalFormContainer').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2">ê²°ì¬ ì–‘ì‹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
    `;

    // ëª¨ë‹¬ í‘œì‹œ
    var modal = new bootstrap.Modal(document.getElementById('approvalFormModal'));
    modal.show();

    try {
        // ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ timestamp ì¶”ê°€
        let timestamp = new Date().getTime();
        let response = await fetch(`/approval/templates/${templateId}?t=${timestamp}`);
        let htmlContent = await response.text();

        // ê¸°ì¡´ ìš”ì†Œ ì œê±° í›„ ìƒˆë¡œìš´ HTML ì‚½ì…
        document.getElementById('approvalFormContainer').outerHTML = `<div id="approvalFormContainer">${htmlContent}</div>`;
		
		// (ì¤‘ìš”) ë™ì  í…Œì´ë¸” ì´ˆê¸°í™”
		initDynamicTable();

		
		
        // ê²°ì¬ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ìë™ ì±„ìš°ê¸°)
        await loadDraftData(templateId);

    } catch (error) {
        console.error("í…œí”Œë¦¿ ë¡œë“œ ì‹¤íŒ¨:", error);
        alert("ê²°ì¬ ì–‘ì‹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
}

/** 2. ëª¨ë‹¬ì´ ë‹«í ë•Œ ê¸°ì¡´ HTML ì‚­ì œ (ìµœì‹  ë°˜ì˜) */
document.getElementById('approvalFormModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('approvalFormContainer').innerHTML = "";
});

/**  3. ê¸°ì•ˆ ë¬¸ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° */
async function loadDraftData(draftId) {
    try {
        const response = await axios.get(`/approval/draft/${draftId}`);
        const draft = response.data;

        console.log("ë¶ˆëŸ¬ì˜¨ ë¬¸ì„œ ë°ì´í„°:", draft);

        // ë°ì´í„° í•„ë“œ ì±„ìš°ê¸°
        document.querySelector("#draftId").value = draft.draftId || ""; // ê¸°ì•ˆì ID ìë™ ì±„ìš°ê¸°
        document.querySelector("#templateId").value = draft.templateId || "";
        document.querySelector("#empId").value = draft.empId || "";
        document.querySelector("#draftTitle").value = draft.draftTitle || "";
        document.querySelector("#draftContent").value = draft.draftContent || "";
        document.querySelector("#draftUrgent").checked = draft.draftUrgent === "Y";
        document.querySelector("#departmentId").value = draft.departmentId || "";

        // `ê¸°ì•ˆì`ì™€ `ë¬¸ì„œë²ˆí˜¸` ìë™ ì±„ìš°ê¸°
        document.querySelector("input[name='draftId']").value = draft.draftId || ""; // ê¸°ì•ˆì ID ìë™ ì±„ìš°ê¸°
        document.querySelector("input[name='docNo']").value = draft.docNo || ""; // ë¬¸ì„œë²ˆí˜¸ ìë™ ì±„ìš°ê¸°

        // âœ… ê²°ì¬ì ëª©ë¡ ë™ì  ì¶”ê°€
        fillApproverTable(draft.draftapproverList);

    } catch (error) {
        console.error("ğŸš¨ ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
        alert("ë¬¸ì„œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
}


/**  4. ê²°ì¬ì ëª©ë¡ ë™ì  ì¶”ê°€ (ì‹œí€€ìŠ¤ ê¸°ë°˜ ID ì²˜ë¦¬) */
function fillApproverTable(approvers) {
    let table = document.querySelector("#approverTable");
    table.innerHTML = ""; // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”

    approvers.forEach((approver, index) => {
        let row = table.insertRow();
        row.classList.add("approverRow");

        let cell1 = row.insertCell(0);
        let cell2 = row.insertCell(1);
        let cell3 = row.insertCell(2);
        let cell4 = row.insertCell(3);
        let cell5 = row.insertCell(4);

        const rowIdPrefix = `approverRow_${index}`; // ì‹œí€€ìŠ¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ID ìƒì„±

        cell1.innerHTML = `<input type="text" id="${rowIdPrefix}_aprId" class="aprId" value="${approver.aprId}" readonly>`;
        cell2.innerHTML = `<input type="text" id="${rowIdPrefix}_approverId" class="approverId" value="${approver.approverId}" readonly>`;
        cell3.innerHTML = `<input type="number" id="${rowIdPrefix}_aprSeq" class="aprSeq" value="${approver.aprSeq}" readonly>`;
        cell4.innerHTML = `<input type="text" id="${rowIdPrefix}_aprStatus" class="aprStatus" value="${approver.aprStatus}" readonly>`;
        cell5.innerHTML = `<input type="text" id="${rowIdPrefix}_aprReason" class="aprReason" value="${approver.aprReason}" readonly>`;
    });
}

/** âœ… 5. ê²°ì¬ ìƒì‹  */
async function submitApprovalForm() {
    const formElement = document.querySelector("#approvalFormContainer form");

    if (!formElement) {
        alert("ì œì¶œí•  ì–‘ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    let draftData = {
        draftId: document.querySelector("#draftId")?.value || null,  
        templateId: document.querySelector("#templateId")?.value || "",
        empId: document.querySelector("#empId")?.value || "",
        draftTitle: document.querySelector("input[name='draftTitle']").value, // í…œí”Œë¦¿ ì œëª© ê°€ì ¸ì˜¤ê¸°
        draftContent: CKEDITOR.instances.draftContent ? CKEDITOR.instances.draftContent.getData() : "",
        draftUrgent: document.querySelector("#draftUrgent")?.checked ? "Y" : "N",
        departmentId: document.querySelector("#departmentId")?.value || "",
        draftapproverList: []
    };

    // ê²°ì¬ì ëª©ë¡ ë™ì  ì¶”ê°€
    document.querySelectorAll(".approverRow").forEach((row, index) => {
        let approver = {
            aprId: row.querySelector(`#approverRow_${index}_aprId`)?.value || "",
            approverId: row.querySelector(`#approverRow_${index}_approverId`)?.value || "",
            aprSeq: row.querySelector(`#approverRow_${index}_aprSeq`)?.value || "",
            aprYn: "N",
            aprStatus: "ëŒ€ê¸°",
            aprReason: row.querySelector(`#approverRow_${index}_aprReason`)?.value || ""
        };
        draftData.draftapproverList.push(approver);
    });

    console.log("ì „ì†¡í•  ë°ì´í„°:", JSON.stringify(draftData, null, 2)); 

    axios.post("/approval/draft/submit", draftData)
        .then(resp => {
            alert("ê²°ì¬ ìƒì‹  ì™„ë£Œ!");
            location.reload();
        })
        .catch(error => {
            console.error("ê²°ì¬ ìƒì‹  ì‹¤íŒ¨:", error.response ? error.response.data : error);
            alert("ê²°ì¬ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        });
}


/** âœ… 6. `ìƒì‹ ` ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ */
document.addEventListener("DOMContentLoaded", function () {
    document.querySelector("#submitApprovalBtn").addEventListener("click", submitApprovalForm);
});


// 3) ëª¨ë‹¬ ë‚´ë¶€ ë™ì  í…Œì´ë¸” ì´ˆê¸°í™” í•¨ìˆ˜
// ëª¨ë‹¬ ë‚´ë¶€ ë™ì  í…Œì´ë¸” ì´ˆê¸°í™”: ì—°ì°¨ í•­ëª©ê³¼ ê²°ì¬ë¼ì¸ ëª¨ë‘ ì´ˆê¸°í™”
  function initDynamicTable() {
    // ì—°ì°¨ í•­ëª© í…Œì´ë¸” (id: dynamic_table1)
    if (document.getElementById('dynamic_table1') &&
        document.getElementById('plus1') &&
        document.getElementById('minus1')) {
      plusMinusRow({
        tableId: "dynamic_table1",
        plusBtnId: "plus1",
        minusBtnId: "minus1",
        copyRowClass: "copyRow1",
        // ì¶”ê°€ ì˜µì…˜ í•„ìš” ì‹œ ì„¤ì • (ì˜ˆ: maxRow ë“±)
        plusRowCallback: function() { console.log("ì—°ì°¨ í–‰ ì¶”ê°€ ì™„ë£Œ"); },
        minusRowCallback: function() { console.log("ì—°ì°¨ í–‰ ì‚­ì œ ì™„ë£Œ"); }
      });
    }
    // ê²°ì¬ë¼ì¸ í…Œì´ë¸” (id: approverTable)
    if (document.getElementById('approverTable') &&
        document.getElementById('plusApprover') &&
        document.getElementById('minusApprover')) {
      plusMinusRow({
        tableId: "approverTable",
        plusBtnId: "plusApprover",
        minusBtnId: "minusApprover",
        copyRowClass: "copyRow2",
        // ì¶”ê°€ ì˜µì…˜ í•„ìš” ì‹œ ì„¤ì •
        plusRowCallback: function() { console.log("ê²°ì¬ë¼ì¸ í–‰ ì¶”ê°€ ì™„ë£Œ"); },
        minusRowCallback: function() { console.log("ê²°ì¬ë¼ì¸ í–‰ ì‚­ì œ ì™„ë£Œ"); }
      });
    }
  }
  // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ë™ì  í…Œì´ë¸” ì´ˆê¸°í™” (ê²°ì¬ë¼ì¸)
  document.addEventListener("DOMContentLoaded", function() {
    $('#approvalFormModal').on('shown.bs.modal', function() {
      initDynamicTable();
    });
  });
