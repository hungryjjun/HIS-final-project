<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 
 * == ê°œì •ì´ë ¥(Modification Information) ==
 *   ê²°ìž¬ ì§„í–‰ Mapper
 *   ìˆ˜ì •ì¼      			ìˆ˜ì •ìž           ìˆ˜ì •ë‚´ìš©
 *  ============   	============== =======================
 *  2025. 3. 18		  CHOI			  ê¸°ì•ˆìž ê¸°ì¤€ ì²˜ë¦¬
 *
-->
<mapper namespace="kr.or.ddit.mybatis.mappers.approval.ApprovalProcessMapper">
	<resultMap id="draftManageMentMap" type="kr.or.ddit.approval.vo.DraftManageMentVO" >
		<id property="draftId" column="DRAFT_ID"/>
		<result property="templateId" column="TEMPLATE_ID"/>
		<result property="empId" column="EMP_ID"/>
		<result property="draftTitle" column="DRAFT_TITLE"/>
		<result property="draftContent" column="DRAFT_CONTENT"/>
		<result property="draftFile" column="DRAFT_FILE"/>
		<result property="draftDate" column="DRAFT_DATE" jdbcType="DATE"/>
		<result property="draftUrgent" column="DRAFT_URGENT"/>
		<result property="departmentId" column="DEPARTMENT_ID"/>
		<result property="draftStatus" column="DRAFT_STATUS"/>
		<!-- ìµœì¢… ê²°ìž¬ìž ì •ë³´ ì¶”ê°€ -->
	    <result property="finalApprover" column="FINAL_APPROVER"/>
	    
	    <!-- ì²¨ë¶€íŒŒì¼ ì—¬ë¶€ -->
	    <result property="hasAttachment" column="HAS_ATTACHMENT"/>
		
		
		<!-- ê¸°ì•ˆìž ì •ë³´ -->
	    <association property="employee" javaType="kr.or.ddit.employee.vo.EmployeeVO">
	        <id property="empId" column="EMP_ID"/>
	        <result property="name" column="DRAFT_EMP_NAME"/>
	        <result property="departmentId" column="DRAFT_DEPARTMENT"/>
	    </association>

	    <!-- ë¬¸ì„œí•¨ ëª©ë¡ (1:N) -->
	    <collection property="draftBoxList" ofType="kr.or.ddit.approval.vo.DraftBoxVO" autoMapping="true">
	        <id property="boxId" column="BOX_ID"/>
	    </collection>
	
	    <!-- ê²°ìž¬ìž ëª©ë¡ (1:N) -->
	    <collection property="draftapproverList" ofType="kr.or.ddit.approval.vo.DraftApproverVO" autoMapping="true" >
	        <id property="aprId" column="APR_ID"/>
	    </collection>
	
	    <!-- ì°¸ì¡°ìž/ìˆ˜ì‹ ìž ëª©ë¡ (1:N) -->
	    <collection property="draftParList" ofType="kr.or.ddit.approval.vo.DraftParVO">
	        <id property="parId" column="PAR_ID"/>
	    </collection>
	    
	    
        <!--  íŒŒì¼ ìƒì„¸ ì •ë³´ ì¶”ê°€ -->
	   <collection property="fileDetails" ofType="FileDetailVO">
	       <id property="detailId" column="DETAIL_ID"/>
	       <result property="fileId" column="FILE_ID"/>
	       <result property="fileName" column="FILE_NAME"/>
	       <result property="fileSavename" column="FILE_SAVENAME"/>
	       <result property="filePath" column="FILE_PATH"/>
	       <result property="fileStatus" column="FILE_STATUS"/>
	       <result property="fileSize" column="FILE_SIZE"/>
	       <result property="fileType" column="FILE_TYPE"/>
	       <result property="uploadDate" column="UPLOAD_DATE"/>
	   </collection>
	    
	</resultMap>

	<!-- ê¸°ì•ˆìžê°€ ë³¸ì¸ì˜ ë¯¸ê²°í•¨ ì¿¼ë¦¬!! -->
	<select id="writeDraftMangeMent" resultMap="draftManageMentMap" parameterType="String">
	    SELECT
	        dm.draft_id,
	        dm.draft_title,
	        dm.draft_date,
	        dm.draft_status,
	        emp.name          AS draft_emp_name,
	        emp.department_id AS draft_department,
	        (
	            SELECT name
	            FROM employee
	            WHERE emp_id = (
	                SELECT approver_id
	                FROM draft_approver
	                WHERE draft_id = dm.draft_id
	                ORDER BY apr_seq DESC
	                FETCH FIRST 1 ROWS ONLY
	            )
	        ) AS final_approver,
	        CASE
	            WHEN dm.draft_file IS NOT NULL THEN 1
	            ELSE 0
	        END AS has_attachment
	    FROM
	        draft_management dm
	    JOIN employee emp ON dm.emp_id = emp.emp_id
	    WHERE
	        dm.emp_id = #{empId}
	        AND dm.draft_status IN ('ëŒ€ê¸°', 'ê²°ìž¬ ì§„í–‰ ì¤‘')  -- ðŸ›  ë¯¸ê²°í•¨ ì¡°ê±´ ì¶”ê°€
	    ORDER BY
	        dm.draft_date DESC
	</select>

	
	<!-- ê¸°ì•ˆëœ ë¬¸ì„œ ì „ì²´ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ -> ê¸°ì•ˆìž ì •ë³´, ë¬¸ì„œ ì¹´í…Œê³ ë¦¬, ìµœì¢… ê²°ìž¬ìž, ì²¨ë¶€ íŒŒì¼ ì—¬ë¶€  -->
	<select id="writeDraftMangeMentList" resultMap="draftManageMentMap">
		SELECT
		    dm.draft_id
		  , dm.draft_title
		  , dm.draft_date
		  , dm.draft_status
		  , emp.name AS draft_emp_name
		  , dt.template_category
		  , coalesce(to_char(emp.department_id)
		             , 'ë¯¸ì§€ì •') AS draft_department
		  , (
		        SELECT
		            name
		        FROM
		            employee
		        WHERE
		            emp_id = (
		                SELECT
		                    approver_id
		                FROM
		                    draft_approver
		                WHERE
		                    draft_id = dm.draft_id
		                ORDER BY
		                    apr_seq DESC
		                FETCH FIRST 1 ROWS ONLY
		            )
		    )        AS final_approver
		  , CASE
		          WHEN dm.draft_file IS NOT NULL THEN
		              1
		          ELSE
		              0
		      END      AS has_attachment
		FROM
		         draft_management dm
		    JOIN employee       emp ON dm.emp_id = emp.emp_id
		    JOIN draft_template dt ON dm.template_id = dt.template_id
		ORDER BY
		    dm.draft_date DESC
	
	</select>
	
	
	<!-- 1. ì „ìžê²°ìž¬ ë¬¸ì„œ ê¸°ì•ˆ (INSERT)  -> ë¬¸ì„œ í¼ì´ ë°”ë€Œì–´ë„ ì²˜ë¦¬ ê°€ëŠ¥í•¨ -->
   <insert id="insertDraftManagement" parameterType="DraftManageMentVO">
    <!-- draftIdì™€ templateIdëŠ” ì‹œí€€ìŠ¤ ê°’ìœ¼ë¡œ ìžë™ ìƒì„± -->
    	   <!-- 1) INSERT ì „ì— ì‹œí€€ìŠ¤ ê°’ ë¯¸ë¦¬ ì¡°íšŒ -->
	    <selectKey keyProperty="draftId" resultType="Long" order="BEFORE">
	        SELECT DRAFT_ID_SEQ.NEXTVAL FROM DUAL
	    </selectKey>
    
    
	    INSERT INTO DRAFT_MANAGEMENT (
	        DRAFT_ID, TEMPLATE_ID, EMP_ID, DRAFT_TITLE, 
	        DRAFT_CONTENT, DRAFT_DATE, DRAFT_URGENT, 
	        DEPARTMENT_ID, DRAFT_STATUS, DRAFT_FILE
	    ) VALUES (
	        #{draftId}, #{templateId}, #{empId}, #{draftTitle}, 
	        #{draftContent}, SYSDATE, #{draftUrgent}, 
	        #{departmentId}, 'ëŒ€ê¸°', #{draftFile}
	    )
	</insert>
	<!-- í…œí”Œë¦¿ ì œëª© ì¡°íšŒ -->
	<select id="selectTemplateTitle" parameterType="Long" resultType="String">
	    SELECT TEMPLATE_TITE
	    FROM DRAFT_TEMPLATE
	    WHERE TEMPLATE_ID = #{templateId}
	</select>
	

    <!-- 2. ê²°ìž¬ìž ì •ë³´ ì¶”ê°€ -->
	<insert id="insertDraftApprover" parameterType="kr.or.ddit.approval.vo.DraftApproverVO">
		<selectKey keyProperty="aprId" resultType="Long" order="BEFORE">
			 SELECT APR_ID_SEQ.NEXTVAL FROM DUAL
		</selectKey>
	    INSERT INTO DRAFT_APPROVER (
	        APR_ID, DRAFT_ID, APPROVER_ID, APR_SEQ, 
	        APR_YN, APR_STATUS, APR_DATE, APR_REASON, APPROVER_NAME
	    ) VALUES (
	       #{aprId}, #{draftId}, #{approverId}, #{aprSeq}, 
	        'N', #{aprStatus}, SYSDATE, #{aprReason}, #{approverName}
	    )
	</insert>
	<!-- ê²°ìž¬ìž ì´ë¦„ ì°¾ê¸° -->
	<select id="selectApproverName" parameterType="String" resultType="kr.or.ddit.approval.vo.DraftApproverVO">
		 SELECT 
	       e.NAME as approverName
	    FROM DRAFT_APPROVER a
	    JOIN EMPLOYEE e ON a.APPROVER_ID = e.EMP_ID
	    WHERE e.NAME = #{approverName}
	</select>
	
	<!-- ì—°ì°¨ ì‹ ì²­ì„œì— í•´ë‹¹ íƒ€ìž… ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°  -->
	<select id="selectAvailableAnnualTypes" resultType="kr.or.ddit.annual.vo.AnnualManageVO">
	    SELECT ANNUAL_CODE as cd,
	           ANNUAL_NAME as nm,
	           ANNUAL_INFO,
	           ANNUAL_STATUS
	      FROM ANNUAL_TYPE
	     WHERE ANNUAL_STATUS = 'Y'
	     ORDER BY ANNUAL_CODE
	</select>
	
	<!--ì—°ì°¨ ì‹ ì²­ì„œ  ìž‘ì„± -->
	<insert id="insertAnnualHistory" parameterType="kr.or.ddit.annual.vo.AnnualHistoryVO">
	    <!-- ì‹œí€€ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ PRIMARY KEY ìƒì„± (ì˜¤ë¼í´ ê°€ì •) -->
	    <selectKey keyProperty="historyId" resultType="Long" order="BEFORE">
	        SELECT HISTORY_ID_SEQ.NEXTVAL FROM DUAL
	    </selectKey>
	    
	    INSERT INTO ANNUAL_HISTORY (
	        HISTORY_ID, EMP_ID, LEAVE_DATE, LEAVE_END_DATE,
	        STATUS, REASON, REJECT_REASON, REQUEST_DATE, ANNUAL_CODE
	    ) VALUES (
	        #{historyId}, #{empId}, 
	        TO_DATE(#{leaveDate}, 'YYYY-MM-DD'),
        	TO_DATE(#{leaveEndDate}, 'YYYY-MM-DD'),
	        #{status},
	        #{reason}, #{rejectReason}, SYSDATE, #{annualCode}
	    )
	</insert>
	

    <!-- 3. ë¬¸ì„œí•¨ ë“±ë¡ -->
	<insert id="insertDraftBox" parameterType="DraftBoxVO">
		<selectKey keyProperty="boxId" resultType="Long" order="BEFORE">
			 SELECT BOX_ID_SEQ.NEXTVAL FROM DUAL
		</selectKey>
	    INSERT INTO DRAFT_BOX (
	        BOX_ID, DRAFT_ID, EMP_ID, APPROVER_ID, 
	        DOC_TITLE, DOC_STATUS, DOC_CATEGORY, DOC_TYPE, 
	        LAST_UPDATE, CREATE_DATE, DOC_FILE
	    ) VALUES (
	        #{boxId}, #{draftId}, #{empId}, #{approverId}, 
	        #{docTitle}, 'ëŒ€ê¸°', #{docCategory}, #{docType}, 
	        SYSDATE, SYSDATE, #{docFile}
	    )
	</insert>


    <!-- 4. ê²°ìž¬ìž ì²˜ë¦¬ (ìŠ¹ì¸/ë°˜ë ¤/ë³´ë¥˜) -->
    <update id="updateDraftApprover" parameterType="kr.or.ddit.approval.vo.DraftApproverVO">
        UPDATE DRAFT_APPROVER
        SET APR_YN = 'Y', 
            APR_STATUS = #{aprStatus}, 
            APR_DATE = SYSDATE, 
            APR_REASON = #{aprReason}
        WHERE DRAFT_ID = #{draftId} AND APPROVER_ID = #{approverId}
    </update>

    <!-- 5. ë‚¨ì€ ê²°ìž¬ìž ìˆ˜ í™•ì¸ (ë§ˆì§€ë§‰ ê²°ìž¬ìž ì²´í¬) -->
    <select id="countPendingApprovals" parameterType="Long" resultType="int">
        SELECT COUNT(*) 
        FROM DRAFT_APPROVER
        WHERE DRAFT_ID = #{draftId} 
        AND APR_YN = 'N'
    </select>

    <!-- 6. ë¬¸ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸ (ë§ˆì§€ë§‰ ê²°ìž¬ìž ìŠ¹ì¸ ì‹œ) -->
    <update id="updateDraftManagementStatus" parameterType="DraftManageMentVO">
        UPDATE DRAFT_MANAGEMENT
        SET DRAFT_STATUS = #{draftStatus}
        WHERE DRAFT_ID = #{draftId}
    </update>

    <!--  7. ë¬¸ì„œí•¨ ìƒíƒœ ì—…ë°ì´íŠ¸ -->
    <update id="updateDraftBoxStatus" parameterType="DraftBoxVO">
        UPDATE DRAFT_BOX
        SET DOC_STATUS = #{docStatus}, LAST_UPDATE = SYSDATE
        WHERE DRAFT_ID = #{draftId}
    </update>
	
	
	<!-- FILE_DETAIL í…Œì´ë¸”ì— í…œí”Œë¦¿ IDì™€ íŒŒì¼ ID ë§¤í•‘ -->
	<insert id="insertDraftMentFile" parameterType="map" >
        INSERT INTO FILE_DETAIL (FILE_ID, DRAFT_FILE)
        SELECT
            F.FILE_ID,
            #{draftId}
        FROM "FILE" F
        WHERE F.FILE_ID = #{fileIds}
	</insert>
	
</mapper>