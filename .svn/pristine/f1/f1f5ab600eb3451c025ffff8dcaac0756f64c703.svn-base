function connectWebSocket() {
	console.log("ğŸ”Œ WebSocket ì—°ê²° ì‹œë„...");

	let socket = new SockJS('/wss');  // ì„œë²„ì™€ì˜ ì—°ê²°
	stompClient = Stomp.over(socket);

	stompClient.connect({}, function(frame) {
		console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ: " + frame);

		// ìƒíƒœ ë³€ê²½ ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ
		stompClient.subscribe('/topic/onlineStatus', function(message) {
			let statusUpdate = message.body;
			console.log("ğŸ”„ ìƒíƒœ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ : ", statusUpdate);

			// ì§ì› ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
			loadEmployeeList();
		});
	}, function(error) {
		console.error("âŒ WebSocket ì—°ê²° ì‹¤íŒ¨", error);
	});
}

function loadEmployeeList() {
	console.log("ğŸ“¥ ì§ì› ëª©ë¡ ìš”ì²­");

	$.ajax({
		url: "/messenger/empList",
		type: "GET",
		dataType: "json",
		success: function(data) {
			console.log("ğŸ“‹ ì§ì› ëª©ë¡ ìˆ˜ì‹  ì™„ë£Œ", data);

			// 1. ë°ì´í„°ë¥¼ íŠ¸ë¦¬ êµ¬ì¡°ë¡œ ë³€í™˜
			const treeData = {};

			data.forEach(emp => {
				const dept = emp.department?.departmentName || "ë¯¸ì§€ì • ë¶€ì„œ";
				const team = emp.teamName || "ë¯¸ì§€ì • íŒ€";

				if (!treeData[dept]) treeData[dept] = {};
				if (!treeData[dept][team]) treeData[dept][team] = [];

				treeData[dept][team].push(emp);
			});

			//íŠ¸ë¦¬ HTML ìƒì„±
			let html = `<h3>ì§ì› ëª©ë¡</h3><div id="empListWrapper"><ul id="orgTree">`;

			for (const deptName in treeData) {
				html += `<li><span class="toggle"><i class="fas fa-building" style="margin-right: 5px;"></i>${deptName}</span><ul style="display:none;">`;

				for (const teamName in treeData[deptName]) {
					html += `<li><span class="toggle"><i class="fas fa-users" style="margin-right: 5px;"></i>${teamName}</span><ul style="display:none;">`;

					treeData[deptName][teamName].forEach(emp => {
						html += `
						<li class="employee-item" data-emp-id="${emp.empId}" style="cursor: pointer;">
						    <i class="fas fa-user"></i> ${emp.empName} (${emp.rankName || 'N/A'}) 
						    - ${emp.status === 'ì˜¨ë¼ì¸' ? 'ğŸŸ¢' : 'âšª'} ${emp.status}
						</li>

                        `;
					});

					html += `</ul></li>`; // end team
				}

				html += `</ul></li>`; // end dept
			}

			html += `</ul></div>`; // end tree, wrapper
			$("#contentArea").html(html);

			//í† ê¸€ ê¸°ëŠ¥ ì—°ê²°
			$(document).off("click", ".toggle").on("click", ".toggle", function() {
				$(this).siblings("ul").slideToggle();
				$(this).toggleClass("open");
			});
			//í´ë¦­ ì‹œ ì±„íŒ…ë°© ì—´ê¸°
			$(".employee-item").on("click", function() {
				const empId = $(this).data("emp-id");
				openChatWith(empId);
			});
		},
		error: function() {
			alert("âŒ ì§ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
		}
	});
}



function openChatWith(targetEmpId) {
	const currentEmpId = sessionStorage.getItem("currentUserId");
	console.log("âœ… currentUserId: ", currentEmpId);
	console.log("ğŸ¯ targetEmpId: ", targetEmpId);

	if (!currentEmpId || !targetEmpId) {
		alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
		return;
	}

	$.ajax({
		url: "/messenger/selectOrInsertRoom",
		method: "POST",
		data: {
			empId1: currentEmpId,
			empId2: targetEmpId
		},
		success: function(roomId) {
			console.log("âœ… ì±„íŒ…ë°© ìƒì„± or ì¡°íšŒ ì„±ê³µ, ROOM_ID: ", roomId);
			const popupName = `chatRoom_${roomId}`;
			const popupOptions = "width=600,height=500,left=300,top=100,resizable=yes,scrollbars=yes";

			window.open(`/messenger/room?roomId=${roomId}`, popupName, popupOptions);
		},
		error: function() {
			alert("âŒ ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
		}
	});
}
$(document).ready(function() {
	console.log("ğŸ“¦ chatempList.js ë¡œë“œë¨");

	connectWebSocket();
	loadEmployeeList();

	$("#empListBtn").on("click", function(e) {
		e.preventDefault();
		console.log("ğŸ‘† ì§ì› ëª©ë¡ ë²„íŠ¼ í´ë¦­ë¨");
		loadEmployeeList();
	});
});
