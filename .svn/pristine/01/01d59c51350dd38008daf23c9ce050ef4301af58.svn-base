package kr.or.ddit.file.service;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.io.Resource;
import org.springframework.core.io.ResourceLoader;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import kr.or.ddit.file.vo.FileDetailVO;
import kr.or.ddit.file.vo.FileInfoVO;
import kr.or.ddit.file.vo.FileVO;
import kr.or.ddit.mybatis.mappers.file.FileMapper;

@Service
public class FileInfoService {

    @Autowired
    private FileMapper mapper;
    
    @Autowired
    private FileInfoVO fileInfoVO; // FileInfoVO ì£¼ì…

    
    @Autowired
    private ResourceLoader resourceLoader; // Spring Resource ë¡œë”
    
    @Autowired
    public FileInfoService(FileMapper mapper, FileInfoVO fileInfoVO) {
        this.mapper = mapper;
        this.fileInfoVO = fileInfoVO;
    }

    
    /**
    * íŒŒì¼ ê·¸ë£¹ (FILE_ID) ìƒì„±
    */
   @Transactional
   public Long createFileGroup() {
       FileVO fileVO = new FileVO();
       fileVO.setFileDel("N");  // ì‚­ì œ ì—¬ë¶€ ê¸°ë³¸ê°’
       mapper.insertFile(fileVO); // ìƒˆ FILE_ID ìƒì„±
       return fileVO.getFileId(); // ìƒì„±ëœ FILE_ID ë°˜í™˜
   }
    
   
   /**
    * ê¸°ì¡´ íŒŒì¼ ê·¸ë£¹ (FILE_ID)ì— íŒŒì¼ ì—…ë°ì´íŠ¸ ë˜ëŠ” ì¶”ê°€ (íŒŒì¼ êµì²´ ê°€ëŠ¥)
    */
   @Transactional
   public List<Long> updateFileGroup(Long fileId, MultipartFile[] files) throws IOException {
       if (fileId == null) {
           throw new IllegalArgumentException("íŒŒì¼ ê·¸ë£¹ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.");
       }

       List<Long> detailIds = new ArrayList<>();
       Path uploadPath = Paths.get(fileInfoVO.getFileImages());

       // ğŸ“Œ ì—…ë¡œë“œ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ìƒì„±
       if (!Files.exists(uploadPath)) {
           Files.createDirectories(uploadPath);
       }

       long totalRequestSize = 0;

       // ğŸ“Œ ê¸°ì¡´ íŒŒì¼ ì‚­ì œ (ê¸°ì¡´ íŒŒì¼ì„ ìœ ì§€í•˜ë©´ì„œ ì¶”ê°€í•  ê²½ìš°, ì´ ë¶€ë¶„ ì œê±° ê°€ëŠ¥)
       List<FileDetailVO> existingFiles = mapper.getFileDetailsByFileId(fileId);
       for (FileDetailVO fileDetail : existingFiles) {
           if (fileDetail != null && fileDetail.getFilePath() != null) {
               Path existingFilePath = Paths.get(fileDetail.getFilePath());
               try {
                   Files.deleteIfExists(existingFilePath); // ì‹¤ì œ íŒŒì¼ ì‚­ì œ
               } catch (IOException e) {
                   throw new RuntimeException("íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: " + existingFilePath, e);
               }
               mapper.deleteFile(fileDetail.getDetailId());  // DBì—ì„œ ê°œë³„ íŒŒì¼ ì‚­ì œ
           }
       }

       //ìƒˆë¡œìš´ íŒŒì¼ ì—…ë¡œë“œ
       for (MultipartFile file : files) {
           if (file == null || file.isEmpty()) {
               continue; // ë¹ˆ íŒŒì¼ì€ ë¬´ì‹œ
           }

           long fileSize = file.getSize();

           // íŒŒì¼ í¬ê¸° ê²€ì¦
           if (fileSize > fileInfoVO.getMaxFileSize() * 1024 * 1024) {
               throw new IllegalArgumentException("íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤.");
           }

           totalRequestSize += fileSize;
           if (totalRequestSize > fileInfoVO.getMaxRequestSize() * 1024 * 1024) {
               throw new IllegalArgumentException("ì „ì²´ ìš”ì²­ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤.");
           }

           String originalFileName = file.getOriginalFilename();
           String uuidFileName = UUID.randomUUID().toString() + "_" + originalFileName;
           Path filePath = uploadPath.resolve(uuidFileName);

           try {
               Files.copy(file.getInputStream(), filePath, StandardCopyOption.REPLACE_EXISTING);

               FileDetailVO fileDetail = new FileDetailVO();
               fileDetail.setFileId(fileId);
               fileDetail.setFileName(originalFileName);
               fileDetail.setFileSavename(uuidFileName);
               fileDetail.setFilePath(filePath.toString());
               fileDetail.setFileSize(fileSize);
               fileDetail.setFileType(file.getContentType());

               mapper.insertFileDetail(fileDetail);
               detailIds.add(fileDetail.getDetailId());

           } catch (IOException e) {
               throw new IOException("íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: " + filePath, e);
           }
       }

       return detailIds;
   }

   
   
   
    
   
   @Transactional
   public List<Long> saveFiles(MultipartFile[] files) throws Exception {
       List<Long> detailIds = new ArrayList<>();
       Path uploadPath = Paths.get(fileInfoVO.getFileImages());

       // ë””ë ‰í† ë¦¬ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ë° ìƒì„±
       if (!Files.exists(uploadPath)) {
           Files.createDirectories(uploadPath);
       }

       long totalRequestSize = 0;
       
       //  1ï¸ í•œ ë²ˆë§Œ 'FILE_ID' ìƒì„±
       FileVO fileVO = new FileVO();
       fileVO.setFileDel("N");  // ì‚­ì œ ì—¬ë¶€ ê¸°ë³¸ê°’
       mapper.insertFile(fileVO);  // FILE í…Œì´ë¸”ì— ì‚½ì…
       Long fileId = fileVO.getFileId();  // ìƒì„±ëœ FILE_IDë¥¼ ì €ì¥

       // íŒŒì¼ì„ í•˜ë‚˜ì”© ì €ì¥
       for (MultipartFile file : files) {
           long fileSize = file.getSize();

           // ê°œë³„ íŒŒì¼ í¬ê¸° ì œí•œ ê²€ì‚¬
           if (fileSize > fileInfoVO.getMaxFileSize() * 1024 * 1024) {
               throw new IllegalArgumentException("íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤.");
           }

           totalRequestSize += fileSize;
           if (totalRequestSize > fileInfoVO.getMaxRequestSize() * 1024 * 1024) {
               throw new IllegalArgumentException("ì „ì²´ ìš”ì²­ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤.");
           }

           String originalFileName = file.getOriginalFilename();
           String uuidFileName = UUID.randomUUID().toString() + "_" + originalFileName;
           Path filePath = uploadPath.resolve(uuidFileName);

           try {
               Files.copy(file.getInputStream(), filePath, StandardCopyOption.REPLACE_EXISTING);

               // 2ï¸ ë™ì¼í•œ 'FILE_ID'ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ ìƒì„¸ ì •ë³´ ì‚½ì…
               FileDetailVO fileDetail = new FileDetailVO();
               fileDetail.setFileId(fileId); // ê·¸ë£¹í™”ëœ 'FILE_ID' ì‚¬ìš©
               fileDetail.setFileName(originalFileName);
               fileDetail.setFileSavename(uuidFileName);
               fileDetail.setFilePath(filePath.toString());
               fileDetail.setFileSize(fileSize);
               fileDetail.setFileType(file.getContentType());

               // ìì‹ í…Œì´ë¸”ì— ì‚½ì…
               mapper.insertFileDetail(fileDetail);
               detailIds.add(fileDetail.getDetailId()); // ì‚½ì…ëœ DETAIL_ID ì¶”ê°€

           } catch (IOException e) {
               throw new IOException("íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: " + filePath, e);
           }
       }

       return detailIds;
   }



    // íŒŒì¼ IDë¡œ íŒŒì¼ ì •ë³´ ì¡°íšŒ
    public FileDetailVO getFileById(Long detailId) {
        return mapper.getFileById(detailId); // fileIdë¥¼ ì‚¬ìš©
    }

    
    // íŒŒì¼ ì‚­ì œ
    @Transactional
    public void deleteFile(Long fileId) {
        FileDetailVO fileDetail = mapper.getFileById(fileId);
        if (fileDetail != null) {
            Path filePath = Paths.get(fileDetail.getFilePath());

            try {
                Files.deleteIfExists(filePath); // íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ íŒŒì¼ ì‚­ì œ
            } catch (IOException e) {
                throw new RuntimeException("íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: " + filePath, e);
            }

            // DBì—ì„œ ë…¼ë¦¬ì  ì‚­ì œ (ìƒíƒœ ë³€ê²½)
            mapper.deleteFile(fileId); // fileIdë¥¼ ì‚¬ìš©
        }
    }

    /**
     * ëª¨ë“  íŒŒì¼ ëª©ë¡ ì¡°íšŒ
     */
    public List<FileDetailVO> getAllFiles() {
        return mapper.getAllFiles();
    }
  
    /**
     *  Resource í™œìš©
     */
    private File getUploadDirectory() throws IOException {
        Resource resource = resourceLoader.getResource(fileInfoVO.getFileUploads());
        File uploadDir = resource.getFile(); // `Resource`ì—ì„œ `File` ê°ì²´ ê°€ì ¸ì˜¤ê¸°


        // ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±
        if (!uploadDir.exists()) {
            uploadDir.mkdirs();
        }
        return uploadDir;
    }
    
    

    /**
     * íŒŒì¼ ì €ì¥ (ì•ˆì •ì ì¸ ê²½ë¡œ ì„¤ì • ì ìš©)
     */
    @Transactional
    public Long saveFileWithGroup(MultipartFile file, Long fileId) throws IOException {
        if (file == null || file.isEmpty()) {
            throw new IllegalArgumentException("ì—…ë¡œë“œëœ íŒŒì¼ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
        }

        File uploadPath = getUploadDirectory(); // ì•ˆì •ì ì¸ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°

        // íŒŒì¼ëª… ìƒì„± (UUID ì¶”ê°€í•˜ì—¬ ì¤‘ë³µ ë°©ì§€)
        String originalFileName = file.getOriginalFilename();
        String uuidFileName = UUID.randomUUID().toString() + "_" + originalFileName;
        File savedFile = new File(uploadPath, uuidFileName);

        try {
            file.transferTo(savedFile); // íŒŒì¼ ì €ì¥
        } catch (IOException e) {
            throw new IOException("íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: " + savedFile.getAbsolutePath(), e);
        }

        // íŒŒì¼ ìƒì„¸ ì •ë³´ ìƒì„±
        FileDetailVO fileDetail = new FileDetailVO();
        fileDetail.setFileId(fileId);
        fileDetail.setFileName(originalFileName);
        fileDetail.setFileSavename(uuidFileName);
        fileDetail.setFilePath(savedFile.getAbsolutePath());
        fileDetail.setFileSize(file.getSize());
        fileDetail.setFileType(file.getContentType());

        // DBì— íŒŒì¼ ì •ë³´ ì €ì¥
        mapper.insertFileDetail(fileDetail);

        return fileDetail.getDetailId();
    }



}

