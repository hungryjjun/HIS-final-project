/**
 * 
 */let mainStompClient = null;
const currentUserId = sessionStorage.getItem("currentUserId");

function connectMainWebSocket() {
  const socket = new SockJS("/wss");
  mainStompClient = Stomp.over(socket);

  mainStompClient.connect({}, function (frame) {
    console.log("âœ… ë©”ì¸ WebSocket ì—°ê²°ë¨:", frame);

    // ëª¨ë“  ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ ìˆ˜ì‹ 
    mainStompClient.subscribe("/topic/chat/global", function (message) {
      const chat = JSON.parse(message.body);
      handleIncomingMessage(chat);
    });
  });
}

function handleIncomingMessage(chat) {
  const isMine = chat.senderId === currentUserId;
  const openRoomId = sessionStorage.getItem("openRoomId"); // ì—´ë ¤ìˆëŠ” ë°©

  // ì•Œë¦¼ ì¡°ê±´
  if (!isMine && Notification.permission === "granted") {
    if (String(chat.roomId) !== openRoomId) {
      console.log("ğŸ”” ë©”ì‹ ì € ë©”ì¸ - ì•Œë¦¼ ì‹¤í–‰!");
      new Notification(`${chat.senderName}ë‹˜`, {
        body: chat.messageText,
        icon: "https://cdn-icons-png.flaticon.com/512/3588/3588530.png"
      });
    } else {
      console.log("ğŸ“ª ë©”ì‹ ì € ë©”ì¸ - ì—´ë ¤ìˆëŠ” ì±„íŒ…ë°©ì´ì–´ì„œ ì•Œë¦¼ X");
    }
  }
}

function requestNotificationPermission() {
  if (!("Notification" in window)) return;
  if (Notification.permission === "default") {
    Notification.requestPermission();
  }
}

// DOM ë¡œë”© ì‹œ ì—°ê²°
$(document).ready(function () {
  requestNotificationPermission();
  connectMainWebSocket();
});
