<!-- 
 * == ê°œì •ì´ë ¥(Modification Information) ==
 *   
 *   ìˆ˜ì •ì¼      			ìˆ˜ì •ì           ìˆ˜ì •ë‚´ìš©
 *  ============   	============== =======================
 *  2025. 3. 31.     	ì •íƒœìš°            ìµœì´ˆ ìƒì„±
 *
-->
<%@ page language="java" contentType="text/html; charset=UTF-8"
   pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="security" %>

<style>
#calendar {
transform: scale(0.99); /* 80% í¬ê¸°ë¡œ ì¶•ì†Œ */
   width: 100%;
   height: 500px;
/*    max-width: 600px; /* ì›í•˜ëŠ” ìµœëŒ€ ë„ˆë¹„ë¡œ ì„¤ì • */ */
/*    margin: auto;   /* ê°€ìš´ë° ì •ë ¬(ì˜µì…˜) */ */
}
/* ì‹œê°„ ì •ë³´ ìŠ¤íƒ€ì¼ */
/* ì¶”ê°€ ìŠ¤íƒ€ì¼: ê°„ê²©ê³¼ ì •ë ¬ */
span {
    display: inline-block;
    margin-left: 20px;
}
#doc-id {
    width: 5%;
}

#title {
    width: 10%;
}

#draft-date {
    width: 1%;
}

#status {
    width: 1%;
}

#draftor {
    width: 1%;
}

#department {
    width: 1%;
}

#approver {
    width: 1%;
}

#approval-status {
    width: 10%;
}

#approval-progress {
    width: 15%;
}

#attachment {
    width: 1%;
}
.card {
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    background-color: #fff;
    padding: 20px;
}
h4{
 	text-align: center;
}
.card-header {
    background-color: #f8f9fa;
    padding: 10px 15px;
    border-bottom: 1px solid #ddd;
    font-weight: bold;
}

.card-body {
    padding: 15px;
}

.btn-outline-info {
    border-radius: 5px;
    font-size: 14px;
     margin-top: 10px;
    padding: 8px;
    border: 1px solid #ddd;
}


        .btn-outline-info {
            color: #0B3C5D;
            border-color: #0B3C5D;
        }

        .btn-outline-info:hover {
            background-color: #0B3C5D;
            color: #fff;
        }

        .chart-container {
            background: #fff;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            height: 320px;
        }

        canvas {
            height: 220px !important;
        }
</style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

		<security:authentication property="principal" var="principal" />
<div id="main" class="layout-horizontal">
 <h3 class="mb-4">ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”, HR ê´€ë¦¬ìë‹˜</h3>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-header">ì „ì²´ ì§ì› ìˆ˜</div>
                    <div class="card-body"><h2>132ëª…</h2></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-header">ì˜¬í•´ ì…ì‚¬ì</div>
                    <div class="card-body"><h2>18ëª…</h2></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-header">ì˜¬í•´ í‡´ì‚¬ì</div>
                    <div class="card-body"><h2>5ëª…</h2></div>
                </div>
            </div>
        </div>
	<div class="page-content">
		<section class="row">
			<!-- ìº˜ë¦°ë” ì™¼ìª½ -->
			<div class="col-12 col-lg-6">
<!-- 			 ìº˜ë¦°ë”ìˆë˜ ìë¦¬ -->
<div class="row g-4">
            <div class="col-md-6">
                <div class="chart-container">
                    <h6>ğŸ’¼ ë¶€ì„œë³„ í‰ê·  ê¸‰ì—¬</h6>
                    <canvas id="deptSalaryChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h6>ğŸ“Š ì§ê¸‰ë³„ í‰ê·  ê¸‰ì—¬</h6>
                    <canvas id="rankSalaryChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h6>ğŸ“¥ ì±„ìš© í˜„í™©</h6>
                    <canvas id="recruitChart"></canvas>
                </div>
            </div>
        </div>
			</div>
			<div class="col12- col-lg-3">
				<div class="card-content pb-3">
<!-- 				   ì˜¤ëŠ˜ í• ì¼ ìˆë˜ ìë¦¬ -->
				</div>

			</div>
			<!-- ìº˜ë¦°ë” ì˜¤ë¥¸ìª½ (í”„ë¡œí•„ ì •ë³´) -->
			<div class="col-12 col-lg-3">
				<div class="card">
					<div class="card-body py-3 px-5">
						<div class="d-flex align-items-center">
							<div class="avatar avatar-xl">
								<img
									src="${pageContext.request.contextPath}/resources/template/dist/assets/static/images/faces/1.jpg"
									alt="Face 1">
							</div>
							<div class="ms-3 name">
								<h6>${principal.realUser.department.departmentName} ${principal.realUser.employee.team.teamName}</h6>
								<h5 class="text-muted mb-0">${principal.realUser.empName }  ${principal.realUser.rank.rankName }</h5>

															<a href="javascript:logoutStatus()" >ë¡œê·¸ì•„ì›ƒ</a>
							</div>
						</div>
					</div>
				</div>
				<div class="card">
					<div class="card-header">
						<h4>ë‚˜ì˜ ê·¼íƒœ</h4>
					</div>
					<div class="card-body py-6 px-5">
						<h6>
							<span id="time"></span>
						</h6>
						<c:if test="${not empty sessionAccount.attendance}">
							<c:forEach items="${sessionAccount.attendance}" var="attendance">
							    <span id="startTime" class="time-info">ì¶œê·¼ ì‹œê°„: <strong>${attendance.workStartTime}</strong></span><br/>
								<span id="endTime" class="time-info">í‡´ê·¼ ì‹œê°„: <strong>${attendance.workEndTime}</strong></span><br/>
								<span>ì¼í•œ ì‹œê°„: 
								    <span class="workDuration" data-workstart="${attendance.workStartTime}" data-workend="${attendance.workEndTime}">
								    </span>
								</span><br/>
							</c:forEach>
						</c:if>
						<c:if test="${empty sessionAccount.attendance}">
								<span id="startTime" >ì¶œê·¼ ì‹œê°„   </span> <br/>
							    <span id="endTime" >í‡´ê·¼ ì‹œê°„  </span> <br/>
							    <span>ì¼í•œ ì‹œê°„ </span> <br/>
						</c:if>

						<a class="btn btn-outline-info" href="${pageContext.request.contextPath}/generate-qr" data-bs-toggle="modal" data-bs-target="#exampleModal__" >ì¶œ/í‡´QR</a>
						<select id="workStatusSelect" name="workStatus" onchange="updateWorkStatus()" class="btn btn-outline-info">
						    <c:forEach items="${workStatusList}" var="workStatusVO">
						        <c:if test="${workStatusVO.statusPos eq 'Y'}">  
						            <option value="${workStatusVO.statusId}"
						                    ${workStatusVO.statusId eq workStatus.statusId ? 'selected' : ''}
						                    ${workStatus.statusId eq 'STAT_03' && workStatusVO.statusId ne 'STAT_03' ? 'disabled' : ''}>
						                ${workStatusVO.statusName}
						            </option>
						        </c:if>
						    </c:forEach>
						</select>
					</div>
				</div>


			</div>
		</section>

      <section class="row">
         <!-- ê²Œì‹œíŒ (ì™¼ìª½) -->
         <div class="col-12 col-lg-6">
            <div class="card">
               <div class="card-body">
					<section class="section">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title"><a href="${pageContext.request.contextPath }/board/list" class="text-decoration-none text-grey">ê³µì§€ì‚¬í•­</a></h5>

            </div>
            <script>
                function navigateToDetail(postId) {
                    console.log("Navigating to detail with noticeId:", postId); // ë¡œê·¸ ì¶”ê°€
                    window.location.href = "${pageContext.request.contextPath}/board/detail?noticeId=" + postId;
                }
            </script>
            <div class="card-body">
                <div class="dataTable-wrapper dataTable-loading no-footer sortable searchable fixed-columns">
                    <div class="dataTable-container">
                        <table id="table1" class="table table-striped datatable">
                            <thead>
                                <tr>
                                    <th data-sortable=""><a href="#" class="dataTable-sorter">ê¸€ë²ˆí˜¸</a></th>
                                    <th data-sortable=""><a href="#" class="dataTable-sorter">ì¹´í…Œê³ ë¦¬</a></th>
                                    <th data-sortable=""><a href="#" class="dataTable-sorter">ì œëª©</a></th>
                                    <th data-sortable=""><a href="#" class="dataTable-sorter">ì‘ì„±ì</a></th>
                                    <th data-sortable=""><a href="#" class="dataTable-sorter">ì‘ì„±ì¼</a></th>
                                    <th data-sortable=""><a href="#" class="dataTable-sorter">ì¡°íšŒìˆ˜</a></th>
                                </tr>
                            </thead>
                            <tbody>
                                <c:choose>
                                    <c:when test="${not empty boardList}">
                                        <c:forEach items="${boardList}" var="board">
                                            <tr>
                                                <td>${board.noticeId}</td>
                                                <td>${board.category.categoryName}</td>
                                                <td>
                                                    <a href="javascript:void(0);" onclick="navigateToDetail('${board.noticeId}')">${board.title}</a>
                                                </td>
                                                <td>${board.role.roleName}</td>
                                                <td>${board.createdAt}</td>
                                                <td>${board.viewCount}</td>
                                            </tr>
                                        </c:forEach>
                                    </c:when>
                                    <c:otherwise>
                                        <tr>
                                            <td colspan="6">ê³µì§€ê¸€ ì—†ìŒ.</td>
                                        </tr>
                                    </c:otherwise>
                                </c:choose>
                            </tbody>
                        </table>

                  </div>
              </div>
          </div>
      </div>
  </section>
               </div>
            </div>
         </div>

         <!-- ê²Œì‹œíŒ ì˜¤ë¥¸ìª½ (appoverProcess.jsp) -->
         <div class="col-12 col-lg-6">
    <div class="card">
        <div class="card-body">
            <section class="section">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title"><a href="${pageContext.request.contextPath }/approval/approverDrafts">ê²°ì¬ëŒ€ê¸°í•¨</a></h4>
                    </div>

                    <div class="card-body">
                        <!-- ë°ì´í„° í…Œì´ë¸”ì„ ê°€ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê¸° -->
                        <div class="table-responsive" style="max-width: 100%; overflow-x: auto;">
                            <table id="approvalTable" class="table table-striped datatable">
                                <thead>
                                    <tr>
										<th id="doc-id"><a href="#" class="dataTable-sorter">ë¬¸ì„œID</a></th>
										<th id="title"><a href="#" class="dataTable-sorter">ì œëª©</a></th>
										<th id="draft-date"><a href="#" class="dataTable-sorter">ê¸°ì•ˆì¼</a></th>
										<th id="status"><a href="#" class="dataTable-sorter">ìƒíƒœ</a></th>
										<th id="draftor"><a href="#" class="dataTable-sorter">ê¸°ì•ˆì</a></th>
										<th id="department"><a href="#" class="dataTable-sorter">ë¶€ì„œ</a></th>
										<th id="approver"><a href="#" class="dataTable-sorter">ê²°ì¬ì</a></th>
										<th id="approval-status"><a href="#" class="dataTable-sorter">ìŠ¹ì¸ì—¬ë¶€</a></th>
										<th id="approval-progress"><a href="#" class="dataTable-sorter">ê²°ì¬ ì§„í–‰ìƒíƒœ</a></th>
										<th id="attachment"><a href="#" class="dataTable-sorter">ì²¨ë¶€íŒŒì¼</a></th>

                                    </tr>
                                </thead>
                                <tbody id="draftDocumentsContainer">
                                    <tr>
                                        <td colspan="10"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>


      </section>
   </div>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal__" tabindex="-1"
	aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="exampleModalLabel">ì¶œí‡´ê·¼ QR</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body"></div>
		</div>
	</div>
</div>

    <!-- íˆ¬ë‘ë¦¬ìŠ¤íŠ¸ í•  ì¼ ì¶”ê°€ ëª¨ë‹¬ ì°½ -->
	<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
	    <div class="modal-dialog modal-dialog-centered">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="taskModalLabel">í•  ì¼ ì¶”ê°€</h5>
	                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	            </div>
	            <div class="modal-body">
	                <div class="form-group">
	                    <label for="taskInput" class="form-label">í•  ì¼ ì…ë ¥</label>
	                    <textarea class="form-control" id="taskInput" rows="3"></textarea>
	                </div>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
	                <button type="button" class="btn btn-primary" id="saveTask">ì €ì¥</button>
	            </div>
	        </div>
	    </div>
	</div>

<!-- Simple DataTables ìŠ¤í¬ë¦½íŠ¸ -->
<script src="${pageContext.request.contextPath}/resources/js/approval/approverProcess.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script src="${pageContext.request.contextPath}/resources/js/qr/qrModal.js"></script>
<script src="${pageContext.request.contextPath}/resources/js/content/updateTime.js"></script>
<script src="${pageContext.request.contextPath}/resources/js/content/updateWorkedTime.js"></script>
<script src="${pageContext.request.contextPath}/resources/js/qr/qrWorkStatusUpdate.js"></script>
<script>
	var empId = '${principal.realUser.empId}'; //ë¡œê·¸ì¸í•œ ì‚¬ì›ì˜ Id
	console.log("empId",empId)
   //í˜ì´ì§€ê°€ ë¡œë“œë˜ë©´ ì‹œê°„ì„ ì—…ë°ì´íŠ¸í•˜ê³ , 1ì´ˆë§ˆë‹¤ ê°±ì‹ 
   window.onload = function() {
      updateTime();
      updateWorkedTime();   // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°”ë¡œ ì‹¤í–‰
      setInterval(updateTime, 1000); // 1ì´ˆë§ˆë‹¤ ì‹œê°„ ê°±ì‹ 
      setInterval(updateWorkedTime, 1000);
      connectAndSendStatus();
   };
   
   function updateWorkStatus() {
		var statusId = $('#workStatusSelect').val();  // ì„ íƒëœ ìƒíƒœ ID
		$.ajax({
			url: '/workstauts/updateWorkStatus',  // ì„œë²„ì˜ URL
			type: 'POST',
			data: {
				statusId: statusId,
				empId: empId,
				workDate: workDate
			},
			success: function(response) {
				alert('ì—…ë°ì´íŠ¸ ì„±ê³µ');
			},
			error: function() {
				alert('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
			}
		});
	}
   let stompClient = null;

   function connectAndSendStatus() {
       const socket = new SockJS('/wss');
       stompClient = Stomp.over(socket);

       stompClient.connect({}, function(frame) {
           console.log('ğŸŸ¢ WebSocket ì—°ê²°ë¨ (ë¡œê·¸ì¸ ìƒíƒœ ì•Œë¦¼ìš©)', frame);

           // ì˜¨ë¼ì¸ ìƒíƒœ ì„œë²„ì— ì „ì†¡
           stompClient.send("/app/status", {}, JSON.stringify({
               empId: empId,
               status: "ì˜¨ë¼ì¸"
           }));
       });
   }


   function logoutStatus() {
   	if (stompClient) {
   		stompClient.send("/app/status", {}, JSON.stringify({
   			empId: empId,
   			status: "ì˜¤í”„ë¼ì¸"
   		}));
   	}
   	setTimeout(() => {
   		location.href = "/account/login/logout";
   	}, 300);
   }

   var scheduleList = [];
   <c:if test="${not empty scheduleList}">
       <c:forEach items="${scheduleList}" var="x">
           scheduleList.push({
               empId: "${x.empId}",
               scheduleTitle: "${x.scheduleTitle}",
               scheduleContext: "${x.scheduleContext}",
               startDate: "${x.startDate}",
               endDate: "${x.endDate}",
               scheduleVisibility: "${x.scheduleVisibility}",
               colorCode: "${x.colorCode}"
           });
       </c:forEach>
   </c:if>;
   
$(document).ready(function(){
    var drake = dragula([document.getElementById("todoList")]);

    loadTasks(); // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°

    $('#addTaskBtn').click(function(){
        $('#taskModal').modal('show');
    });

    $('#saveTask').click(function(){
        var taskText = $('#taskInput').val().trim();
        if(taskText) {
            addTaskToList(taskText);
            saveTasks(); // âœ… í•  ì¼ ì €ì¥
            $('#taskInput').val("");
            $('#taskModal').modal('hide');
        }
    });

    $('#todoList').on('change', 'input[type="checkbox"]', function(){
        if(this.checked){
            $(this).closest('li').fadeOut(function(){
                $(this).remove();
                saveTasks(); // âœ… ì‚­ì œ í›„ ì €ì¥
            });
        }
    });

    function addTaskToList(taskText) {
        var newTask = $('<li class="list-group-item d-flex align-items-center"></li>');
        var listIcon = $('<i data-feather="list" class="cursor-move me-2" style="font-size: 20px;"></i>');

        var checkbox = $('<input type="checkbox" class="form-check-input me-2">');
        var label = $('<span></span>').text(taskText);

        newTask.append(listIcon).append(checkbox).append(label);
        $('#todoList').append(newTask);
        feather.replace();

        drake.destroy();
        drake = dragula([document.getElementById("todoList")]);
    }

    function saveTasks() {
        let tasks = [];
        $("#todoList li").each(function() {
            let text = $(this).find("span").text();
            tasks.push(text);
        });
        localStorage.setItem("todoTasks", JSON.stringify(tasks));
    }

    function loadTasks() {
        let savedTasks = localStorage.getItem("todoTasks");
        if (savedTasks) {
            savedTasks = JSON.parse(savedTasks);
            savedTasks.forEach(task => {
                addTaskToList(task);
            });
        }
    }
});
new Chart(document.getElementById('deptSalaryChart'), {
    type: 'bar',
    data: {
        labels: ['ê°œë°œë¶€', 'ì¸ì‚¬ë¶€', 'ì˜ì—…ë¶€', 'ë””ìì¸íŒ€', 'ê²½ì˜ì§€ì›'],
        datasets: [{
            label: 'ë¶€ì„œë³„ í‰ê·  ê¸‰ì—¬ (ë§Œì›)',
            data: [420, 380, 400, 390, 410],
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: { callback: value => value + 'ë§Œì›' }
            }
        }
    }
});

new Chart(document.getElementById('rankSalaryChart'), {
    type: 'doughnut',
    data: {
        labels: ['ì‚¬ì›', 'ëŒ€ë¦¬', 'ê³¼ì¥', 'ì°¨ì¥', 'ë¶€ì¥'],
        datasets: [{
            label: 'ì§ê¸‰ë³„ í‰ê·  ê¸‰ì—¬',
            data: [320, 380, 450, 520, 600],
            backgroundColor: [
                '#6fa8dc', '#3c78d8', '#0b5394', '#073763', '#1c4587'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'right' }
        }
    }
});

new Chart(document.getElementById('recruitChart'), {
    type: 'bar',
    data: {
        labels: ['í”„ë¡ íŠ¸ì—”ë“œ', 'ë°±ì—”ë“œ', 'ë””ìì¸', 'ë§ˆì¼€íŒ…'],
        datasets: [{
            label: 'ì§€ì›ì ìˆ˜',
            data: [12, 18, 5, 7],
            backgroundColor: 'rgba(255, 159, 64, 0.7)'
        }]
    },
    options: {
        responsive: true,
        indexAxis: 'y',
        scales: {
            x: {
                beginAtZero: true,
                ticks: { stepSize: 5 }
            }
        }
    }
});
</script>
