package kr.or.ddit.approval.controller;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.inject.Inject;
import javax.servlet.http.HttpSession;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import kr.or.ddit.account.service.AccountService;
import kr.or.ddit.account.vo.AccountVO;
import kr.or.ddit.approval.service.ApprovalProcessService;
import kr.or.ddit.approval.vo.DraftManageMentVO;
import kr.or.ddit.approval.vo.DraftTemplateVO;
import kr.or.ddit.department.service.DepartmentService;
import kr.or.ddit.department.vo.DepartmentVO;
import kr.or.ddit.departmentboard.service.DepartmentBoardService;
import kr.or.ddit.departmentboard.vo.DepartmentBoardVO;
import kr.or.ddit.employee.service.EmployeeService;
import kr.or.ddit.employee.vo.EmployeeVO;

/**
 * 
 * @author CHOI
 * @since 2025. 3. 20.
 * @see
 *
 * <pre>
 * << 개정이력(Modification Information) >>
 *   
 *   수정일      			수정자           수정내용
 *  -----------   	-------------    ---------------------------
 *  2025. 3. 20.     	CHOI	          기안자 기준(결재 처리)
 *
 * </pre>
 */
@RestController
public class ApprovalDraftController {
	
	@Inject
	private ApprovalProcessService service;
	
	@Inject
	private EmployeeService empService;
	
	
	@Inject
	private DepartmentService deboService;
	
	/**
     *  로그인한 사용자의 empId 가져오기
     */
    @GetMapping("/approval/draft/getEmpId")
    public ResponseEntity<String> getLoggedInEmpId() {
        Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        if (principal instanceof UserDetails) {
            return ResponseEntity.ok(((UserDetails) principal).getUsername());
        }
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("Unauthorized");
    }
	

	/**
	 * 기안 문서 상신
	 * @param draftMentVO
	 * @return
	 */
    @PostMapping("/approval/draft/submit")
    public ResponseEntity<String> submitApproval(@RequestBody DraftManageMentVO draftMentVO) {
        try {
            // 템플릿 제목을 자동으로 가져오는 로직 추가
            String templateTitle = service.getTemplateTitle(draftMentVO.getTemplateId());
            
            // 제목이 존재하지 않으면 기본 제목 설정
            if (templateTitle == null || templateTitle.isEmpty()) {
                templateTitle = "기본 문서 제목";  // 기본 제목
            }

            draftMentVO.setDraftTitle(templateTitle);  // 템플릿 제목을 DRAFT_TITLE에 설정

            // 기안 문서 상신 로직 처리
            service.submitDraft(draftMentVO, draftMentVO.getDraftapproverList(), draftMentVO.getDraftBoxList());
            return ResponseEntity.ok("결재 문서가 상신되었습니다.");
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("결재 상신 실패");
        }
    }

	
	
	
	/**
	 * 관리자 또는 특정 사용자가 특정 기안자의 문서를 조회
	 * -> 로그인 세션 정보 없는 조회
	 * @param empId
	 * @return
	 */
	@GetMapping("/approval/draft/my")
	public ResponseEntity<List<DraftManageMentVO>> getDraftsByEmpId(@RequestParam String empId) {
	    return ResponseEntity.ok(service.writeDraftMangeMent(empId));
	}
	
	
	/**
	 * 템플릿 ID에 해당하는 데이터를 JSON으로 반환
	 * @return 템플릿 내부 input name 값에 맞는 데이터 키로 매핑
	 */
	@GetMapping("/approval/draft/data/{templateId}")
	public ResponseEntity<?> getDraftData(@PathVariable("templateId") Long templateId, HttpSession session) {
	    try {
	        AccountVO accountVO = (AccountVO) session.getAttribute("sessionAccount");

	        // 세션이 없는 경우 에러 처리
	        if (accountVO == null) {
	            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("세션이 만료되었습니다.");
	        }

	        Map<String, Object> formData = new HashMap<>();
	        formData.put("empId", accountVO.getEmpId());  // 기안자 ID
	        formData.put("draftUser", accountVO.getEmpName()); // 기안자 이름
	        formData.put("draftDept", accountVO.getDepartmentId()); // 부서 ID

	        // 부서명 조회 추가
	        DepartmentVO deptVO = deboService.getDepartmentById(accountVO.getDepartmentId());
	        if (deptVO != null) {
	            formData.put("draftDept", deptVO.getDepartmentName()); // 부서명을 삽입
	        } else {
	            formData.put("draftDept", "부서 정보 없음");
	        }

	        // 직원 상세 정보 조회
	        EmployeeVO empVO = empService.readEmp(accountVO.getEmpId());
	        if (empVO != null) {
	            formData.put("position", empVO.getPosition()); // 직급
	            formData.put("email", empVO.getEmail()); // 이메일 추가
	        }

	        // 결재 관련 정보 (추가 필요 시)
	        formData.put("draftDate", LocalDate.now().toString()); // 오늘 날짜
	        formData.put("docNo", LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd")) + templateId);

	        return ResponseEntity.ok(formData);

	    } catch (Exception e) {
	        e.printStackTrace();
	        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("데이터 조회 실패");
	    }
	}


	
}
