<%@ page language="java" contentType="text/html; charset=UTF-8"
   pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="security" %>
<!-- 
 * == ê°œì •ì´ë ¥(Modification Information) ==
 *   
 *   ìˆ˜ì •ì¼               ìˆ˜ì •ì           ìˆ˜ì •ë‚´ìš©
 *  ============      ============== =======================
 *  2025-03-12          ì •íƒœìš°            ìµœì´ˆ ìƒì„±
 *  2025-03-14          ì •íƒœìš°            ì¶œê·¼ í‡´ê·¼ ì¼í•œì‹œê°„ ì‚½ì…
 *  2025-03-17          ì´ì˜ì¤€            securityì¬ ì„¤ì • ì„¸ì…˜ê°’ ë³€ê²½
 *
-->
<style>
#calendar {
   transform: scale(0.85); /* 80% í¬ê¸°ë¡œ ì¶•ì†Œ */
   width: 100%;
}

.messengerSTbtn {
   position: absolute;
   top: 20px;
   right: 20px;
}

/* ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ìˆ¨ê¸°ê¸° */
.layer_transition {
   display: none;
   position: absolute;
   top: 50px; /* ë²„íŠ¼ ì•„ë˜ì— í‘œì‹œë˜ë„ë¡ ì¡°ì • */
   z-index: 100;
   width: 200px;
   border: 1px solid #ccc;
   background-color: white;
   box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

/* ë©”ë‰´ í•­ëª© ìŠ¤íƒ€ì¼ */
.submenu-list li {
   padding: 10px;
   cursor: pointer;
}

.submenu-list li:hover {
   background-color: #f0f0f0;
}
</style>
<div id="main" class="layout-horizontal">
	<header class="mb-3">
		<a href="#" class="burger-btn d-block d-xl-none">
		 <i class="bi bi-justify fs-3"></i>
		</a>
	</header>
		<security:authentication property="principal" var="principal" /> 
	<div class="page-content">
		<section class="row">
			<!-- ìº˜ë¦°ë” ì™¼ìª½ -->
			<div class="col-12 col-lg-8">
				<div class="card">
					<script
						src="${pageContext.request.contextPath}/resources/fullcalendar-6.1.15/dist/index.global.js"></script>
					<div id="calendar"></div>
					<div class="modal fade" id="eventModal" tabindex="-1"
						aria-labelledby="eventModalLabel" aria-hidden="true">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title" id="eventModalLabel">ì¼ì •</h5>
									<button class="eventInsert" type="button">ë“±ë¡</button>
									<button class="eventUpdate" type="button">ìˆ˜ì •</button>
									<button type="button" class="btn-close" data-bs-dismiss="modal"
										aria-label="Close"></button>
								</div>
								<div class="modal-body" id="eventList"></div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- ìº˜ë¦°ë” ì˜¤ë¥¸ìª½ (í”„ë¡œí•„ ì •ë³´) -->
			<div class="col-12 col-lg-4">
				<div class="card">
					<div class="card-body py-4 px-5">
						<div class="d-flex align-items-center">
							<div class="avatar avatar-xl">
								<img
									src="${pageContext.request.contextPath}/resources/template/dist/assets/static/images/faces/1.jpg"
									alt="Face 1">
							</div>
							<div class="ms-3 name">
								<h6>${principal.realUser.department.departmentName} ${principal.realUser.teamMember.team.teamName}</h6>
								<h5 class="text-muted mb-0">${principal.realUser.empName }  ${principal.realUser.rank.rankName }</h5>
								
								<a href="<c:url value='/account/login/logout'/>">ë¡œê·¸ì•„ì›ƒ</a>
							</div>
						</div>
					</div>
				</div>
				<div class="card">
					<div class="card-header">
						<h4>ë‚˜ì˜ ê·¼íƒœ</h4> 
					</div>
					<div class="card-content pb-4">
						<h6>
							<span id="time"></span>
						</h6>
						
						
						<c:if test="${not empty sessionAccount.attendance}">
							<c:forEach items="${sessionAccount.attendance}" var="attendance">
							    <span id="startTime">ì¶œê·¼ ì‹œê°„   ${attendance.workStartTime} </span> <br/>
							    <span id="endTime">í‡´ê·¼ ì‹œê°„   ${attendance.workEndTime}</span> <br/>
							    <span>ì¼í•œ ì‹œê°„    
							    	<span class="workDuration" data-workstart="${attendance.workStartTime}" data-workend="${attendance.workEndTime}"></span>
							    </span> <br/>
							</c:forEach>
						</c:if>
						<c:if test="${empty sessionAccount.attendance}">
								<span id="startTime" >ì¶œê·¼ ì‹œê°„   </span> <br/>
							    <span id="endTime" >í‡´ê·¼ ì‹œê°„  </span> <br/>
							    <span>ì¼í•œ ì‹œê°„ </span> <br/>
						</c:if>

						<a class="btn btn-outline-info" href="${pageContext.request.contextPath}/generate-qr"
												data-bs-toggle="modal" data-bs-target="#exampleModal__" >ì¶œ/í‡´QR</a>
						<select id="workStatusSelect" name="workStatus" onchange="updateWorkStatus()" class="btn btn-outline-info">
						    <c:forEach items="${workStatusList}" var="workStatusVO">
						        <c:if test="${workStatusVO.statusPos eq 'Y'}">  <!-- ğŸ”¹ POSê°€ 'Y'ì¸ ê²½ìš°ë§Œ í‘œì‹œ -->
						            <c:choose>
						                <c:when test="${workStatus.statusId eq 'STAT_01' || workStatus.statusId eq 'STAT_02'}">
						                    <option value="${workStatusVO.statusId}" 
						                            ${workStatusVO.statusId eq workStatus.statusId ? 'selected' : ''} 
						                            ${workStatusVO.statusId eq 'STAT_03' ? 'disabled' : ''}>
						                        ${workStatusVO.statusName}
						                    </option>
						                </c:when>
						
						                <c:when test="${workStatus.statusId eq 'STAT_03'}">
						                    <option value="${workStatusVO.statusId}" 
						                            ${workStatusVO.statusId eq 'STAT_03' ? 'selected' : ''} 
						                            ${workStatusVO.statusId ne 'STAT_03' ? 'disabled' : ''}>
						                        ${workStatusVO.statusName}
						                    </option>
						                </c:when>
						            </c:choose>
						        </c:if>
						    </c:forEach>
						</select>
					</div>
				</div>
			</div>
		</section>

      <section class="row">
         <!-- ê²Œì‹œíŒ (ì™¼ìª½) -->
         <div class="col-12 col-lg-8">
            <div class="card">
               <div class="card-body">
                  <%@include file="/WEB-INF/views/includee2/notice.jsp"%>
               </div>
            </div>
         </div>

         <!-- ê²Œì‹œíŒ ì˜¤ë¥¸ìª½ (rufwoanstj.jsp) -->
         <div class="col-12 col-lg-4">
            <div class="card">
               <div class="card-body">
                  <%@include file="/WEB-INF/views/mazer/rufwoanstj.jsp"%>
               </div>
            </div>
         </div>
      </section>
   </div>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal__" tabindex="-1"
	aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="exampleModalLabel">ì¶œí‡´ê·¼ QR</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body"></div>
		</div>
	</div>


<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="${pageContext.request.contextPath}/resources/js/qr/qrModal.js"></script>
<script src="${pageContext.request.contextPath}/resources/js/content/updateTime.js"></script>
<script src="${pageContext.request.contextPath}/resources/js/content/updateWorkedTime.js"></script>
<script src="${pageContext.request.contextPath}/resources/js/qr/qrWorkStatusUpdate.js"></script>
<script>
	const empId = '${workStatus.empId}'
   //í˜ì´ì§€ê°€ ë¡œë“œë˜ë©´ ì‹œê°„ì„ ì—…ë°ì´íŠ¸í•˜ê³ , 1ì´ˆë§ˆë‹¤ ê°±ì‹ 
   window.onload = function() {
      updateTime();
      updateWorkedTime();   // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°”ë¡œ ì‹¤í–‰
      setInterval(updateTime, 1000); // 1ì´ˆë§ˆë‹¤ ì‹œê°„ ê°±ì‹ 
      setInterval(updateWorkedTime, 1000);
   };
   function updateWorkStatus() {
		var statusId = $('#workStatusSelect').val();  // ì„ íƒëœ ìƒíƒœ ID
		$.ajax({
			url: '/workstauts/updateWorkStatus',  // ì„œë²„ì˜ URL
			type: 'POST',
			data: {
				statusId: statusId,
				empId: empId,
				workDate: workDate
			},
			success: function(response) {
				alert('ì—…ë°ì´íŠ¸ ì„±ê³µ');
			},
			error: function() {
				alert('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
			}
		});
	}
</script>
