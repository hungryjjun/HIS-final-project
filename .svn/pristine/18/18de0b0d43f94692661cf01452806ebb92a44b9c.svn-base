function loadChatRoomList() {
	const currentEmpId = sessionStorage.getItem("currentUserId");

	if (!currentEmpId) {
		alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
		return;
	}

	$.ajax({
		url: "/messenger/chatRoom",
		type: "GET",
		data: { empId: currentEmpId },
		dataType: "json",
		success: function(chatRooms) {
			console.log("ğŸ’¬ ì±„íŒ…ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ", chatRooms);

			let html = `
                <h3>ê·¸ë£¹ ì±„íŒ… ìƒì„±</h3>
                <input type="text" id="groupRoomName" placeholder="ì±„íŒ…ë°© ì´ë¦„ ì…ë ¥" />
                <div id="empListContainer"></div>
                <button id="createGroupChatBtn">ê·¸ë£¹ ì±„íŒ…ë°© ë§Œë“¤ê¸°</button>
                <hr/>
                <div id="chatRoomList">
                    <h4>ë‚´ ì±„íŒ…ë°© ëª©ë¡</h4>
					<div id ="chatRoomList">
                    <ul id="chatRoomUl"></ul>
				</div>
				</div>
            `;

			chatRooms.forEach(room => {
				html += `
			        <li class="chat-room-item" 
			            style="margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
			            <div onclick="enterChatRoom(${room.roomId})" style="cursor: pointer;">
			                <strong>${room.roomName || "ì±„íŒ…ë°©"}</strong><br>
			                <small>ìœ í˜•: ${room.roomType}</small>
			            </div>
			            <button onclick="event.stopPropagation(); leaveRoom(${room.roomId})"
			                    style="margin-top: 5px; font-size: 12px; background-color: #ff5c5c; color: white; border: none; padding: 3px 8px; border-radius: 3px;">
			                ë‚˜ê°€ê¸°
			            </button>
			        </li>
			    `;
			});

			html += `</ul></div>`;
			$("#contentArea").html(html);

			loadEmployeesForGroupChat();

			// ê·¸ë£¹ ì±„íŒ…ë°© ìƒì„± ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
			$("#createGroupChatBtn").on("click", function() {
				const roomName = $("#groupRoomName").val();
				const checkedEmpIds = [];

				$("input[name='groupMember']:checked").each(function() {
					checkedEmpIds.push($(this).val());
				});

				const currentUserId = sessionStorage.getItem("currentUserId");
				if (!checkedEmpIds.includes(currentUserId)) {
					checkedEmpIds.push(currentUserId);
				}

				if (!roomName) {
					alert("ì±„íŒ…ë°© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
					return;
				}

				if (checkedEmpIds.length < 2) {
					alert("ì°¸ì—¬ìëŠ” ìµœì†Œ 2ëª… ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
					return;
				}

				const groupRoom = {
					roomName: roomName,
					empIdList: checkedEmpIds
				};

				$.ajax({
					url: "/messenger/insertGroupChat",
					type: "POST",
					contentType: "application/json",
					data: JSON.stringify(groupRoom),
					success: function(roomId) {
						alert("âœ… ê·¸ë£¹ ì±„íŒ…ë°© ìƒì„± ì„±ê³µ!");
						window.open("/messenger/room?roomId=" + roomId, "_blank");
						loadChatRoomList(); // ë‹¤ì‹œ ë¡œë”©
					},
					error: function() {
						alert("âŒ ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨");
					}
				});
			});
		},
		error: function() {
			console.error("âŒ ì±„íŒ…ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
			alert("ì±„íŒ…ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
		}
	});
}

function enterChatRoom(roomId) {
	const popupName = `chatRoom_${roomId}`; // ë°© ë²ˆí˜¸ ê¸°ë°˜ ê³ ìœ  ì°½ ì´ë¦„
	const popupOptions = "width=600,height=500,left=300,top=100,resizable=yes,scrollbars=yes";
	window.open(`/messenger/room?roomId=${roomId}`, popupName, popupOptions);
}

function loadEmployeesForGroupChat() {
	$.ajax({
		url: "/messenger/empList",
		type: "GET",
		success: function(data) {
			let html = "<ul>";
			data.forEach(emp => {
				html += `
                    <li>
                        <label>
                            <input type="checkbox" name="groupMember" value="${emp.empId}">
                            ${emp.empName} (${emp.department?.departmentName || "ë¶€ì„œ ì—†ìŒ"})
                        </label>
                    </li>
                `;
			});
			html += "</ul>";

			$("#empListContainer").html(html);
		},
		error: function() {
			alert("ì§ì› ëª©ë¡ ë¡œë”© ì‹¤íŒ¨");
		}
	});
}
function leaveRoom(roomId) {
	const empId = sessionStorage.getItem("currentUserId");

	if (!confirm("ì±„íŒ…ë°©ì—ì„œ ë‚˜ê°€ê² ì‹œìŠµë‹ˆê¹Œ?")) return;


	$.ajax({
		url: "/messenger/deleteChatMember",
		type: "POST",
		data: { empId: empId, roomId: roomId },
		success: function(res) {
			alert("ì±„íŒ…ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.");
			loadChatRoomList();
		},
		error: function() {
			alert("ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì‹¤íŒ¨");
		}
	});

	//$.post("/messenger/deleteChatMember", { empId, roomId })
	//    .done(function (res) {
	//		console.log("========================================111");
	//		console.log(res);
	//        //alert(res);
	//        //loadChatRoomList(); 
	//    })
	//    .fail(function () {
	//		console.log("========================================222");
	//		console.log("âŒ ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì‹¤íŒ¨");
	//        //alert("âŒ ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì‹¤íŒ¨");
	//    });
}

$(document).ready(function() {
	console.log("ğŸ“¦ chatRoomList.js ë¡œë“œë¨");

	$("#chatRoomBtn").on("click", function(e) {
		e.preventDefault();
		console.log("ğŸ’¬ ì±„íŒ…ë°© ëª©ë¡ ë²„íŠ¼ í´ë¦­ë¨");
		loadChatRoomList();
	});


	// loadChatRoomList();
});
