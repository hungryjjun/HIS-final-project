<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form" %>

<html>
<head>
    <title>í‰ê°€ ëŒ€ìƒì ë“±ë¡</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .readonly { background-color: #f5f5f5; }
    </style>
</head>
<body>

<h2>í‰ê°€ ëŒ€ìƒì ë“±ë¡/ì¡°íšŒ í™”ë©´</h2>

<!-- ğŸ”½ ì•ˆë‚´ ë©”ì‹œì§€ -->
<div>
    <strong>
        í˜„ì¬ëŠ” 
        <c:out value="${currentYear}" />ë…„ 
        <c:out value="${currentHalf}" /> í‰ê°€ ëŒ€ìƒì ë“±ë¡ ê¸°ê°„ì…ë‹ˆë‹¤.
    </strong>
</div>

<!-- ğŸ”² í•„í„° ì˜ì—­ -->
<form method="get" action="/evaluation/evaluationCandidateMain">
    <label>ë…„ë„:</label>
    <select name="year">
        <c:forEach var="y" begin="2020" end="2025">
            <option value="${y}" <c:if test="${y == selectedYear}">selected</c:if>>${y}</option>
        </c:forEach>
    </select>

    <label>êµ¬ë¶„:</label>
    <select name="half">
        <option value="ìƒë°˜ê¸°" ${selectedHalf == 'ìƒë°˜ê¸°' ? 'selected' : ''}>ìƒë°˜ê¸°</option>
        <option value="í•˜ë°˜ê¸°" ${selectedHalf == 'í•˜ë°˜ê¸°' ? 'selected' : ''}>í•˜ë°˜ê¸°</option>
    </select>

    <label>ì§ê¸‰:</label>
    <select name="rank">
        <option value="">ì „ì²´</option>
        <c:forEach var="r" items="${rankList}">
            <option value="${r.rankId}" <c:if test="${r.rankId == selectedRank}">selected</c:if>>${r.rankName}</option>
        </c:forEach>
    </select>

    <button type="submit">ì¡°íšŒ</button>
    <button type="button" onclick="location.reload()">ì´ˆê¸°í™”</button>
</form>

<hr/>

<!-- âœ… í‰ê°€ ëŒ€ìƒì ë¦¬ìŠ¤íŠ¸ í¼ -->
<form:form method="post" modelAttribute="wrapper" action="/evaluationCandidateUpdate">
    <table border="1">
        <thead>
            <tr>
                <th><input type="checkbox" id="checkAll" /></th>
                <th>ì‚¬ë²ˆ</th>
                <th>ì´ë¦„</th>
                <th>ë¶€ì„œ</th>
                <th>íŒ€</th>
                <th>ì§ê¸‰</th>
                <th>ë…„ë„</th>
                <th>êµ¬ë¶„</th>
                <th>í‰ê°€ëŒ€ìƒ</th>
                <th>í‰ê°€ì—¬ë¶€</th>
            </tr>
        </thead>
        <tbody>
            <c:forEach var="candidate" items="${wrapper.candidateList}" varStatus="status">
                <tr>
                    <td>
                        <input type="checkbox" class="rowCheck" name="rowCheck" data-index="${status.index}" />
                        <form:hidden path="candidateList[${status.index}].empId" />
                    </td>
                    <td><c:out value="${candidate.empId}" /></td>
                    <td><c:out value="${candidate.employee.name}" /></td>
                    <td><c:out value="${candidate.department.departmentName}" /></td>
                    <td><c:out value="${candidate.team.teamName}" /></td>
                    <td><c:out value="${candidate.rank.rankName}" /></td>
                    <td>
                        <form:input path="candidateList[${status.index}].evaluationYear" class="evalYear readonly" readonly="true"/>
                    </td>
                    <td>
                        <form:select path="candidateList[${status.index}].halfYear" cssClass="halfYear readonly" disabled="true">
                            <form:option value="ìƒë°˜ê¸°" label="ìƒë°˜ê¸°"/>
                            <form:option value="í•˜ë°˜ê¸°" label="í•˜ë°˜ê¸°"/>
                        </form:select>
                    </td>
                    <td>
                        <form:select path="candidateList[${status.index}].isTarget" cssClass="isTarget readonly" disabled="true">
                            <form:option value="Y" label="Y"/>
                            <form:option value="N" label="N"/>
                        </form:select>
                    </td>
                    <td>
                        <form:hidden path="candidateList[${status.index}].evaluationStatus" />
                        <c:out value="${candidate.evaluationStatus}" />
                    </td>
                </tr>
            </c:forEach>
        </tbody>
    </table>

    <br/>

    <!-- ğŸ”˜ ì¡°ì‘ ë²„íŠ¼ ì˜ì—­ -->
    <button type="button" id="enableEdit">ìˆ˜ì •</button>
    <button type="button" id="cancelEdit">ì·¨ì†Œ</button>
    <button type="button" id="fillBulk">ì¼ê´„ì…ë ¥</button>
    <button type="submit">í‰ê°€ ëŒ€ìƒ í™•ì •</button>
</form:form>

<!-- ğŸ§  ìœ íš¨ì„± ê²€ì‚¬ ë° JS -->
<script>
    // ì „ì²´ ì²´í¬
    $("#checkAll").on("change", function () {
        $(".rowCheck").prop("checked", $(this).is(":checked"));
    });

    // ìˆ˜ì • í™œì„±í™”
    $("#enableEdit").on("click", function () {
        $(".rowCheck:checked").each(function () {
            let idx = $(this).data("index");
            $(`.evalYear:eq(${idx})`).removeClass("readonly").prop("readonly", false);
            $(`.halfYear:eq(${idx})`).removeClass("readonly").prop("disabled", false);
            $(`.isTarget:eq(${idx})`).removeClass("readonly").prop("disabled", false);
        });
    });

    // ì·¨ì†Œ: ë‹¤ì‹œ readonly
    $("#cancelEdit").on("click", function () {
        $(".evalYear, .halfYear, .isTarget").addClass("readonly").prop("readonly", true).prop("disabled", true);
    });

    // ì¼ê´„ì…ë ¥ì€ ë³„ë„ ëª¨ë‹¬ ë˜ëŠ” promptë¡œ ì…ë ¥ê°’ ë°›ì•„ ì²˜ë¦¬ ê°€ëŠ¥
    $("#fillBulk").on("click", function () {
        const year = prompt("ì¼ê´„ì…ë ¥í•  í‰ê°€ë…„ë„:");
        const half = prompt("ì¼ê´„ì…ë ¥í•  êµ¬ë¶„ (ìƒë°˜ê¸°/í•˜ë°˜ê¸°):");
        const isTarget = prompt("ì¼ê´„ì…ë ¥í•  í‰ê°€ëŒ€ìƒ ì—¬ë¶€ (Y/N):");

        $(".rowCheck:checked").each(function () {
            let idx = $(this).data("index");
            $(`.evalYear:eq(${idx})`).val(year);
            $(`.halfYear:eq(${idx})`).val(half);
            $(`.isTarget:eq(${idx})`).val(isTarget);
        });
    });
</script>

</body>
</html>
