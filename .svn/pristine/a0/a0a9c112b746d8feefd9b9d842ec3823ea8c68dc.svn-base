let stompClient;

const senderId = sessionStorage.getItem("currentUserId"); // ì„¸ì…˜ì—ì„œ í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € ID ê°€ì ¸ì˜´

function connectChatRoom() {
  const socket = new SockJS("/wss");
  stompClient = Stomp.over(socket);

  stompClient.connect({}, function (frame) {
    console.log("ğŸŸ¢ ì±„íŒ…ë°© ì—°ê²°ë¨:", frame);

    stompClient.subscribe(`/topic/chat/${roomId}`, function (message) {
      const chat = JSON.parse(message.body);
	  console.log("ë°›ì€ ë©”ì‹œì§€ : ", chat);
      showMessage(chat);
    });
  });
}

function sendMessage() {
  const content = $("#chatInput").val();
  if (!content || !senderId) return;

  const msg = {
    roomId: roomId,
    senderId: senderId,
    messageText: content
  };

  stompClient.send("/app/chat.send", {}, JSON.stringify(msg));
  $("#chatInput").val("");
}

function showMessage(chat) {
  const currentUserId = sessionStorage.getItem("currentUserId"); 
  const isMine = chat.senderId === currentUserId; // 
  console.log("senderId in DOM:", $("#senderId").val());
  console.log("ë‚´ ID:", currentUserId, "ë³´ë‚¸ ì‚¬ëŒ:", chat.senderId, "ë‚´ ë©”ì‹œì§€ì¸ê°€?", isMine);
  console.log("ë‚´ id:", currentUserId, typeof currentUserId)
  console.log("ë©”ì‹œì§€ ë³´ë‚¸ì‚¬ëŒ", chat.senderId, typeof chat.senderId)
  console.log("isMine:", isMine); // true or false
  
  let sentTime = "";
   if (chat.sentAt) {
     const date = new Date(chat.sentAt);
     if (!isNaN(date)) {
       sentTime = date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
     }
   }

  const messageHtml = `
    <div class="chat-message ${isMine ? 'mine' : 'other'}">
		<div class="chat-bubble">
	       <div><strong>${chat.senderName}</strong>: ${chat.messageText}</div>
	       <div class="chat-time">${sentTime}</div>
	     </div>
	   </div>
  `;

  $("#chat-box").append(messageHtml);
  $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);
}




$(document).ready(function () {
  connectChatRoom();

  $("#sendBtn").on("click", sendMessage);

  $("#chatInput").on("keypress", function (e) {
    if (e.which === 13) sendMessage();
  });
  $("#closeBtn").on("click", function () {
    window.close(); 
  });

});
