let stompClient;

const senderId = sessionStorage.getItem("currentUserId"); // ì„¸ì…˜ì—ì„œ í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € ID ê°€ì ¸ì˜´

function connectChatRoom() {
  const socket = new SockJS("/wss");
  stompClient = Stomp.over(socket);

  stompClient.connect({}, function (frame) {
    console.log("ğŸŸ¢ ì±„íŒ…ë°© ì—°ê²°ë¨:", frame);

    stompClient.subscribe(`/topic/chat/${roomId}`, function (message) {
      const chat = JSON.parse(message.body);
	  console.log("ë°›ì€ ë©”ì‹œì§€ : ", chat);
      showMessage(chat);
    });
  });
}

function sendMessage() {
  const content = $("#chatInput").val();
  if (!content || !senderId) return;

  const msg = {
    roomId: roomId,
    senderId: senderId,
    messageText: content
  };

  stompClient.send("/app/chat.send", {}, JSON.stringify(msg));
  $("#chatInput").val("");
}

function showMessage(chat) {
  console.log("ë©”ì‹œì§€ ìˆ˜ì‹  :" , chat);
  const newMsg = `<div><strong>${chat.senderId}</strong>: ${chat.messageText}</div>`;
  $("#chat-box").append(newMsg);
  $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);
}

$(document).ready(function () {
  connectChatRoom();

  $("#sendBtn").on("click", sendMessage);

  $("#chatInput").on("keypress", function (e) {
    if (e.which === 13) sendMessage();
  });
});
