<%@page import="java.time.LocalDate"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.summary-box {
	display: flex;
	gap: 30px;
	margin-bottom: 30px;
}

.summary-box div {
	background: #f5f5f5;
	padding: 20px;
	border-radius: 10px;
	min-width: 150px;
	text-align: center;
}

.chart-container {
	display: flex;
	justify-content: space-between;
	gap: 40px;
	margin-bottom: 40px;
}

.chart-box {
	flex: 1;
	max-width: 48%;
}

canvas {
	width: 100% !important;
	height: 300px !important;
}
</style>

<%
int currentYear = LocalDate.now().getYear();
int cuurentMonth = LocalDate.now().getMonthValue();
%>


<td><%=currentYear%>ë…„ <%=cuurentMonth%>ì›”</td>

<div class="summary-box">
	<h4>ì§ì›ìˆ˜ :${salaryInfo.totalemp }ëª…</h4>
	<h4>ê¸‰ì—¬ë“±ë¡ :${salaryInfo.totalSalaryCount }ëª…</h4>
	<h4>ê¸‰ì—¬ë¯¸ë“±ë¡ :${salaryInfo.notSalaryInsert }ëª…</h4>
	ì¡°íšŒ
</div>

<div>
	<form action="/salary/final/list">
		<h4>í™•ì • :${salaryInfo.confirmedCount }ëª…</h4>
		<button type="submit" class="btn btn-sm btn-outline-primary">ì¡°íšŒ</button>
	</form>
</div>

<div>
	<h4>ì´ ê¸‰ì—¬ :${salaryInfo.totalNetSalary }ì›</h4>
</div>

<!--  ê·¸ë˜í”„: ë¶€ì„œë³„ + ì§ê¸‰ë³„ í‰ê·  ê¸‰ì—¬ -->
<div class="chart-container">
	<div class="chart-box">
		<h4>ğŸ“Š ë¶€ì„œë³„ í‰ê·  ê¸‰ì—¬</h4>
		<canvas id="deptChart"></canvas>
	</div>
	<div class="chart-box">
		<h4>ğŸ“Š ì§ê¸‰ë³„ í‰ê·  ê¸‰ì—¬</h4>
		<canvas id="rankChart"></canvas>
	</div>
</div>



<table class="table" id="table1">
	<thead>
		<tr>
			<th>ê·€ì†ì—°ì›”</th>
			<th>ì‚¬ì›ë²ˆí˜¸</th>
			<th>ì‚¬ì›ëª…</th>
			<th>ë¶€ì„œ</th>
			<th>íŒ€</th>
			<th>ì§ê¸‰</th>
			<th>ê¸°ë³¸ê¸‰</th>
			<th>ì§€ê¸‰ì´ì•¡</th>
			<th>ê³µì œì´ì•¡</th>
			<th>ì‹¤ì§€ê¸‰ì•¡</th>
			<th>ê¸‰ì—¬ìƒì„¸</th>
			<th>ê¸‰ì—¬í™•ì •</th>
			<th>í™•ì •ì¼</th>
		</tr>
	</thead>
	<tbody>
		<c:if test="${not empty salaryList }">
			<c:forEach items="${salaryList }" var="salaryVO">
				<tr>
					<td>${salaryVO.payYear }ë…„${salaryVO.payMonth }ì›”</td>
					<td data-salaryid="${salaryVO.salaryId }">${salaryVO.empId }</td>
					<c:forEach items="${salaryVO.employeeList }" var="employeeVO">
						<td>${employeeVO.name }</td>
						<td>${employeeVO.department.departmentName }</td>
						<td>${employeeVO.team.teamName }</td>
						<td>${employeeVO.rank.rankName }</td>
					</c:forEach>
					<td>${salaryVO.baseSalary }</td>
					<td>${salaryVO.totalPay }</td>
					<td>${salaryVO.totalDeduction }</td>
					<td>${salaryVO.netSalary}</td>
					<td><a href="/salary/detail/${salaryVO.empId} ">ë³´ê¸°</a></td>
					<td><button type="button" class="btn btn-primary" onclick="salaryFix(this)">í™•ì •</button></td>
					<td>2025-05-09</td>
				</tr>
			</c:forEach>
		</c:if>
	</tbody>
</table>
<script>
    const deptChart = new Chart(document.getElementById('deptChart'), {
        type: 'bar',
        data: {
            labels: ['ì¸ì‚¬íŒ€', 'ê°œë°œíŒ€', 'ì˜ì—…íŒ€', 'ì¬ë¬´íŒ€'],
            datasets: [{
                label: 'í‰ê·  ê¸‰ì—¬(ë§Œì›)',
                data: [420, 510, 380, 460],
                backgroundColor: 'rgba(54, 162, 235, 0.7)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });

    const rankChart = new Chart(document.getElementById('rankChart'), {
        type: 'bar',
        data: {
            labels: ['ì‚¬ì›', 'ëŒ€ë¦¬', 'ê³¼ì¥', 'ì°¨ì¥', 'ë¶€ì¥'],
            datasets: [{
                label: 'í‰ê·  ê¸‰ì—¬(ë§Œì›)',
                data: [320, 400, 480, 550, 620],
                backgroundColor: 'rgba(255, 99, 132, 0.7)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });
    
    function salaryFix(button){
    	  const tr = button.closest("tr"); // ë²„íŠ¼ì´ í¬í•¨ëœ í–‰ ì°¾ê¸°
    	  const empId = tr.children[1].textContent.trim(); // ë‘ ë²ˆì§¸ <td>ê°€ empId
    	  const salaryId = tr.children[1].dataset.salaryid;
//     	  console.log("salaryId:",salaryId);
//     	  console.log("ì‚¬ì›ë²ˆí˜¸:", empId);
	    $.ajax({
	        url: "/salary/update/salaryfix", 
	        type: "post",
	        data: {
	        	empId : empId,
	        	salaryId : salaryId
	        },
	        dataType: "json",
	        success: function(data) {
	            alert(data)
	            salary2(data)

	        },
	        error: function() {
	            alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
	        }
	    });
    }
    function salary2(data){
    	 var tableBody = $("#table1 tbody");
         tableBody.empty(); // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ

         if (data.length === 0) {
             tableBody.append("<tr><td class='text-center' colspan='8'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>");
             return;
         }

         $.each(data, function(index, x) {
             var row = "<tr>" +
                 "<td>" + (x.employee.department ? x.employee.department.departmentName : "-") + "</td>" +
                 "<td>" + (x.employee.team ? x.employee.team.teamName : "-") + "</td>" +
                 "<td><a href='/check/Detail?empId=" + x.empId + "'>" + x.employee.name + "</a></td>" +
                 "<td>" + x.employee.phoneNumber + "</td>" +
                 "<td>" + x.workDate + "</td>" +
                 "<td>" + x.workStartTime + "</td>" +
                 "<td>" + x.workEndTime + "</td>" +
                 "<td>" + x.attendanceStatus + "</td>" +
                 "</tr>";
             tableBody.append(row);
         });
    }
</script>

